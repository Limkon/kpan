<%# views/files.ejs %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title><%= locals.pageTitle || ( (locals.viewTargetUsername ? viewTargetUsername : user.username) + ' çš„æ–‡ä»¶') %> - ç¶²è·¯ç¡¬ç¢Ÿ</title>
Â  Â  <link rel="stylesheet" href="/style.css">
Â  Â  <link id="theme-stylesheet" rel="stylesheet" href="">
Â  Â  <style>
Â  Â  Â  Â  /* CSS è®Šé‡å®šç¾© */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --button-primary-bg-color: #007bff;
Â  Â  Â  Â  Â  Â  --button-primary-text-color: #ffffff;
Â  Â  Â  Â  Â  Â  --button-primary-border-color: #007bff;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --button-secondary-bg-color: #6c757d; /* ç”¨æ–¼æ¬¡è¦æŒ‰éˆ•ï¼Œä¾‹å¦‚å–æ¶ˆ */
Â  Â  Â  Â  Â  Â  --button-secondary-text-color: #ffffff;
Â  Â  Â  Â  Â  Â  --button-secondary-border-color: #6c757d;

Â  Â  Â  Â  Â  Â  --input-border-color: #ccc;
Â  Â  Â  Â  Â  Â  --input-bg-color: #fff;
Â  Â  Â  Â  Â  Â  --input-text-color: #333;

Â  Â  Â  Â  Â  Â  --modal-bg: #ffffff;
Â  Â  Â  Â  Â  Â  --modal-text-color: #333;
Â  Â  Â  Â  Â  Â  --modal-border-color: #888;

Â  Â  Â  Â  Â  Â  --rename-form-bg: #ffffff;
Â  Â  Â  Â  Â  Â  --rename-form-border-color: #cccccc;

Â  Â  Â  Â  Â  Â  /* æ–°å¢: è¦–é »æ’­æ”¾å™¨æ¨¡æ…‹æ¡†çš„è®Šé‡ */
Â  Â  Â  Â  Â  Â  --video-modal-bg: #1c1c1c;
Â  Â  Â  Â  Â  Â  --video-modal-text-color: #f1f1f1;
Â  Â  Â  Â  Â  Â  --video-modal-border-color: #333;
Â  Â  Â  Â  Â  Â  --video-modal-close-btn-color: #aaa;
Â  Â  Â  Â  Â  Â  --video-modal-close-btn-hover-color: #fff;
Â  Â  Â  Â  }

Â  Â  Â  Â  .dark-theme {
Â  Â  Â  Â  Â  Â  --button-primary-bg-color: #0056b3;
Â  Â  Â  Â  Â  Â  --button-primary-text-color: #ffffff;
Â  Â  Â  Â  Â  Â  --button-primary-border-color: #0056b3;

Â  Â  Â  Â  Â  Â  --button-secondary-bg-color: #5a6268;
Â  Â  Â  Â  Â  Â  --button-secondary-text-color: #ffffff;
Â  Â  Â  Â  Â  Â  --button-secondary-border-color: #545b62;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --input-border-color: #555;
Â  Â  Â  Â  Â  Â  --input-bg-color: #2c2c2c;Â 
Â  Â  Â  Â  Â  Â  --input-text-color: #e0e0e0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --modal-bg: #2c2c2c;
Â  Â  Â  Â  Â  Â  --modal-text-color: #e0e0e0;
Â  Â  Â  Â  Â  Â  --modal-border-color: #555;

Â  Â  Â  Â  Â  Â  --rename-form-bg: #3a3a3a;
Â  Â  Â  Â  Â  Â  --rename-form-border-color: #555;

Â  Â  Â  Â  Â  Â  /* æ–°å¢: æš—è‰²ä¸»é¡Œä¸‹çš„è¦–é »æ’­æ”¾å™¨æ¨¡æ…‹æ¡†è®Šé‡ */
Â  Â  Â  Â  Â  Â  --video-modal-bg: #2a2a2a;
Â  Â  Â  Â  Â  Â  --video-modal-text-color: #e0e0e0;
Â  Â  Â  Â  Â  Â  --video-modal-border-color: #444;
Â  Â  Â  Â  Â  Â  --video-modal-close-btn-color: #bbb;
Â  Â  Â  Â  Â  Â  --video-modal-close-btn-hover-color: #fff;
Â  Â  Â  Â  }

        /* Header navigation button style */
        .nav-button {
            display: inline-block;
            padding: 8px 12px;
            font-size: 0.9em;
            font-weight: 500; /* Making text a bit bolder like typical buttons */
            line-height: 1.5; /* Standard line height for buttons */
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
            background-color: var(--button-primary-bg-color);
            color: var(--button-primary-text-color) !important; /* Important to override default link color */
            border: 1px solid var(--button-primary-border-color);
            border-radius: 4px;
            text-decoration: none !important; /* Important to override default link underline */
            transition: opacity 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out; /* Smooth transition */
            margin-left: 8px; /* Add some spacing between buttons */
        }

        .nav-button:hover {
            opacity: 0.85;
            text-decoration: none !important;
            color: var(--button-primary-text-color) !important;
        }

        .nav-button:active {
            opacity: 1;
            /* Optional: add a slight press effect if desired */
            /* transform: translateY(1px); */
        }
        /* Adjust nav to accommodate button styles */
        .header-controls nav {
            display: flex; /* Align items in a row */
            align-items: center; /* Vertically align items */
        }


Â  Â  Â  Â  /* å…¶ä»–é€šç”¨æ¨£å¼ */
Â  Â  Â  Â  #selection-action-bar { padding: 10px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; margin-bottom: 15px; display: none; flex-wrap: wrap; gap: 10px; align-items: center; }
Â  Â  Â  Â  .dark-theme #selection-action-bar { background-color: #252525; border-bottom-color: #444; }
Â  Â  Â  Â  #selection-action-bar button { margin: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-checkbox {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  margin-right: 10px;Â 
Â  Â  Â  Â  Â  Â  width: 18px;Â 
Â  Â  Â  Â  Â  Â  height: 18px;Â 
Â  Â  Â  Â  Â  Â  vertical-align: middle;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #file-container.multi-select-mode-active .item-checkbox {
Â  Â  Â  Â  Â  Â  display: inline-block;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .file-entry-selectable { display: flex; align-items: center; width: 100%; }
Â  Â  Â  Â  #file-container.list-view .file-entry-selectable {
Â  Â  Â  Â  Â  Â  padding: 5px 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  #file-container.grid-view .file-entry-selectable {
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .file-content-wrapper {Â 
Â  Â  Â  Â  Â  Â  flex-grow: 1;Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .list-view li { position: relative; }
Â  Â  Â  Â  .list-view .file-entry {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  min-width: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .list-view .file-entry .file-name {Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis;Â 
Â  Â  Â  Â  Â  Â  white-space: nowrap;Â 
Â  Â  Â  Â  Â  Â  flex-shrink: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  .list-view .file-details {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  Â  Â  padding-left: 10px;
Â  Â  Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-theme .list-view .file-details {Â 
Â  Â  Â  Â  Â  Â  color: #bbb;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .list-view .file-details .file-size,
Â  Â  Â  Â  .list-view .file-details .file-modified {
Â  Â  Â  Â  Â  Â  min-width: 80px;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  }
Â  Â  Â  Â  #file-container.grid-view .file-details {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .list-view .file-actions-placeholder {Â 
Â  Â  Â  Â  Â  Â  min-width: 40px;
Â  Â  Â  Â  Â  Â  text-align: right;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-theme .list-view .file-actions-placeholder { color: #aaa; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .list-view li.single-selected-item > .file-entry-selectable,
Â  Â  Â  Â  .grid-view li.single-selected-item {Â 
Â  Â  Â  Â  Â  Â  background-color: #e9e9e9;Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-theme .list-view li.single-selected-item > .file-entry-selectable,
Â  Â  Â  Â  .dark-theme .grid-view li.single-selected-item {
Â  Â  Â  Â  Â  Â  background-color: #404040;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  #move-modal, #create-item-modal, #overwrite-confirm-modal, #video-player-modal { /* æ–°å¢ #video-player-modal */
Â  Â  Â  Â  Â  Â  display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  overflow: auto; background-color: rgba(0,0,0,0.5);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {Â 
Â  Â  Â  Â  Â  Â  background-color: var(--modal-bg) !important;
Â  Â  Â  Â  Â  Â  color: var(--modal-text-color);
Â  Â  Â  Â  Â  Â  margin: 10% auto;Â 
Â  Â  Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid var(--modal-border-color);
Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  width: 90%;Â 
Â  Â  Â  Â  Â  Â  max-width: 500px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(0,0,0,0.3);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content h3 { margin-top: 0; }
Â  Â  Â  Â  .modal-content .form-group { margin-bottom: 15px; }
Â  Â  Â  Â  .modal-content .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
Â  Â  Â  Â  .modal-content .form-group input[type="text"] {
Â  Â  Â  Â  Â  Â  width: 100%; padding: 10px; box-sizing: border-box;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--input-border-color); border-radius: 4px;
Â  Â  Â  Â  Â  Â  background-color: var(--input-bg-color); color: var(--input-text-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-actions { text-align: right; margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }

Â  Â  Â  Â  /* æ–°å¢: è¦–é »æ’­æ”¾å™¨æ¨¡æ…‹æ¡†ç‰¹å®šæ¨£å¼ */
Â  Â  Â  Â  #video-player-modal .modal-content {
Â  Â  Â  Â  Â  Â  background-color: var(--video-modal-bg) !important;
Â  Â  Â  Â  Â  Â  color: var(--video-modal-text-color);
Â  Â  Â  Â  Â  Â  border-color: var(--video-modal-border-color);
Â  Â  Â  Â  Â  Â  max-width: 900px; /* å¯ä»¥æ›´å¤§ä¸€äº›ä»¥å®¹ç´è¦–é » */
Â  Â  Â  Â  Â  Â  margin: 5% auto; /* èª¿æ•´å‚ç›´é‚Šè· */
Â  Â  Â  Â  }
Â  Â  Â  Â  #video-player-modal #video-modal-title {
Â  Â  Â  Â  Â  Â  color: var(--video-modal-text-color);
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #video-player-modal .close-modal-btn {
Â  Â  Â  Â  Â  Â  color: var(--video-modal-close-btn-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  #video-player-modal .close-modal-btn:hover,
Â  Â  Â  Â  #video-player-modal .close-modal-btn:focus {
Â  Â  Â  Â  Â  Â  color: var(--video-modal-close-btn-hover-color);
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  #html5-video-player {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 75vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  background-color: #000; /* è¦–é »èƒŒæ™¯é€šå¸¸ç‚ºé»‘è‰² */
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }


Â  Â  Â  Â  #directory-tree-container {Â 
Â  Â  Â  Â  Â  Â  max-height: 250px;Â 
Â  Â  Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid var(--input-border-color);Â 
Â  Â  Â  Â  Â  Â  padding: 10px;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  background-color: var(--input-bg-color);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #directory-tree-container ul { list-style-type: none; padding-left: 20px; }
Â  Â  Â  Â  #directory-tree-container li { padding: 5px 0; cursor: pointer; border-bottom: 1px dashed var(--input-border-color); }
Â  Â  Â  Â  #directory-tree-container li:last-child { border-bottom: none; }
Â  Â  Â  Â  #directory-tree-container li:hover { background-color: var(--hover-bg, #f0f0f0); }Â 
Â  Â  Â  Â  .dark-theme #directory-tree-container li:hover { --hover-bg: #4a4a4a; }
Â  Â  Â  Â  #directory-tree-container li.selected-dir { background-color: #007bff; color: white; }Â 
Â  Â  Â  Â  .dark-theme #directory-tree-container li.selected-dir { background-color: #0056b3; }

Â  Â  Â  Â  .close-modal-btn { float: right; font-size: 1.5em; font-weight: bold; cursor: pointer; line-height: 1; padding: 0 5px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Grid View Specific Styles --- */
Â  Â  Â  Â  #file-container.grid-view ul {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));Â 
Â  Â  Â  Â  Â  Â  gap: 10px;Â 
Â  Â  Â  Â  Â  Â  list-style-type: none;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  #file-container.grid-view li {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  min-height: 100px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #file-container.grid-view li .file-entry-selectable {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #file-container.grid-view li .file-content-wrapper {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;Â  Â 
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  color: inherit;
Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .grid-view .file-entry {Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â  Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  gap: 6px;Â 
Â  Â  Â  Â  Â  Â  width: 100%;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .grid-view .file-icon-large {Â 
Â  Â  Â  Â  Â  Â  font-size: 3.5em;Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  line-height: 1;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  display: flex;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â  Â 
Â  Â  Â  Â  Â  Â  min-height: 48px;Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 4px;Â  Â  Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .grid-view .file-name {Â 
Â  Â  Â  Â  Â  Â  font-size: 0.8em;Â 
Â  Â  Â  Â  Â  Â  line-height: 1.3;
Â  Â  Â  Â  Â  Â  word-break: break-word;Â 
Â  Â  Â  Â  Â  Â  display: -webkit-box;
Â  Â  Â  Â  Â  Â  -webkit-line-clamp: 1;Â 
Â  Â  Â  Â  Â  Â  -webkit-box-orient: vertical;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  text-overflow: ellipsis;Â 
Â  Â  Â  Â  Â  Â  max-width: 100%;Â  Â  Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #file-container.grid-view.multi-select-mode-active .item-checkbox {
Â  Â  Â  Â  Â  Â  margin-bottom: 6px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- End of Grid View Specific Styles --- */
Â  Â  Â  Â Â 
Â  Â  Â  Â  #select-all-container {Â 
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  padding: 5px 10px;Â 
Â  Â  Â  Â  Â  Â  background-color: #f9f9f9;Â 
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #eee;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dark-theme #select-all-container { background-color: #2e2e2e; border-bottom-color: #444; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #select-all-container.visible-in-multiselect {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  }

Â  Â  Â  Â  #select-all-container label { margin-left: 5px; font-weight: normal;}

Â  Â  Â  Â  .rename-form {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  left: 25px;Â 
Â  Â  Â  Â  Â  Â  right: 5px;Â 
Â  Â  Â  Â  Â  Â  top: calc(100% + 2px);Â 
Â  Â  Â  Â  Â  Â  background-color: var(--rename-form-bg);
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--rename-form-border-color);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.15);Â 
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  max-width: 400px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #file-container.grid-view li .rename-form {
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  top: 100%;Â 
Â  Â  Â  Â  Â  Â  margin-top: 5px;Â 
Â  Â  Â  Â  Â  Â  width: calc(100% - 10px);Â 
Â  Â  Â  Â  Â  Â  max-width: 180px;Â 
Â  Â  Â  Â  Â  Â  right: auto;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .rename-form form.inline-form {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  gap: 8px;Â 
Â  Â  Â  Â  Â  Â  align-items: stretch;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .rename-form input[type="text"],
Â  Â  Â  Â  .rename-form button {
Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â  Â  Â 
Â  Â  Â  Â  Â  Â  line-height: 1.4;Â  Â 
Â  Â  Â  Â  Â  Â  padding-top: 6px;Â  Â  Â 
Â  Â  Â  Â  Â  Â  padding-bottom: 6px;Â Â 
Â  Â  Â  Â  Â  Â  border-radius: 4px;Â  Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  .rename-form input[type="text"] {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding-left: 8px;
Â  Â  Â  Â  Â  Â  padding-right: 8px;
Â  Â  Â  Â  Â  Â  background-color: var(--input-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--input-text-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--input-border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .rename-form button {
Â  Â  Â  Â  Â  Â  padding-left: 12px;Â Â 
Â  Â  Â  Â  Â  Â  padding-right: 12px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  white-space: nowrap;Â 
Â  Â  Â  Â  Â  Â  border-width: 1px;Â 
Â  Â  Â  Â  Â  Â  border-style: solid;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .rename-form button[type="submit"] {
Â  Â  Â  Â  Â  Â  background-color: var(--button-primary-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--button-primary-text-color);
Â  Â  Â  Â  Â  Â  border-color: var(--button-primary-border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .rename-form button.secondary {Â 
Â  Â  Â  Â  Â  Â  background-color: var(--button-secondary-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--button-secondary-text-color);
Â  Â  Â  Â  Â  Â  border-color: var(--button-secondary-border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #upload-actions-container { display: none; padding: 10px 0; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
Â  Â  Â  Â  #upload-actions-container button { margin: 0; }
Â  Â  Â  Â  #upload-section { display: none; padding: 20px; border: 1px solid #dee2e6; border-radius: 6px; margin-top: 0; background-color: #f8f9fa; }
Â  Â  Â  Â  .dark-theme #upload-section { background-color: #3a3a3a; border-color: #444; }
Â  Â  Â  Â  #drop-area { border: 2px dashed #007bff; padding: 20px; text-align: center; border-radius: 5px; background-color: #fff; }
Â  Â  Â  Â  .dark-theme #drop-area { border-color: #0056b3; background-color: #2c2c2c; }
Â  Â  Â  Â  #drop-area.highlight { border-color: #28a745; background-color: #e9f7ef; }
Â  Â  Â  Â  .dark-theme #drop-area.highlight { background-color: #333; }
Â  Â  Â  Â  #drop-area p { margin-bottom: 15px; font-size: 1.1em; color: #6c757d; }
Â  Â  Â  Â  .dark-theme #drop-area p { color: #adb5bd; }
Â  Â  Â  Â  #upload-button { display: none; margin-top: 15px; }

Â  Â  Â  Â  .search-results-info { padding: 10px; background-color: #e9ecef; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; }
Â  Â  Â  Â  .dark-theme .search-results-info { background-color: #3a3a3a; }
Â  Â  Â  Â  .file-location-in-search { font-size: 0.8em; color: #6c757d; margin-left: 8px; }
Â  Â  Â  Â  .dark-theme .file-location-in-search { color: #adb5bd; }

Â  Â  Â  Â  .file-browser-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 20px; }
Â  Â  Â  Â  .file-browser-controls .actions-group-left { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .file-browser-controls .actions-group-left button,
Â  Â  Â  Â  #toggle-multi-select-btn {Â 
Â  Â  Â  Â  Â  Â  padding: 8px 12px;Â 
Â  Â  Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--button-primary-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--button-primary-text-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--button-primary-border-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-browser-controls .actions-group-left button:hover,
Â  Â  Â  Â  #toggle-multi-select-btn:hover {
Â  Â  Â  Â  Â  Â  opacity: 0.9;
Â  Â  Â  Â  }

Â  Â  Â  Â  .file-browser-controls .search-form-right { display: flex; align-items: center; gap: 5px; margin-left: auto; flex-shrink: 0; }
Â  Â  Â  Â  .file-browser-controls .search-form-right input[type="search"] {Â 
Â  Â  Â  Â  Â  Â  width: 180px; padding: 8px 10px; font-size: 0.9em;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid var(--input-border-color);Â 
Â  Â  Â  Â  Â  Â  background-color: var(--input-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--input-text-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px; margin: 0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-browser-controls .search-form-right button {Â 
Â  Â  Â  Â  Â  Â  padding: 8px 12px; font-size: 0.9em; margin: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--button-primary-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--button-primary-text-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--button-primary-border-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-browser-controls .view-toggle { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
Â  Â  Â  Â  .file-browser-controls .view-toggle button {Â 
Â  Â  Â  Â  Â  Â  padding: 8px 12px; font-size: 0.9em; margin: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--button-secondary-bg-color);
Â  Â  Â  Â  Â  Â  color: var(--button-secondary-text-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--button-secondary-border-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .file-browser-controls .view-toggle button.active {
Â  Â  Â  Â  Â  Â  background-color: var(--button-primary-bg-color);
Â  Â  Â  Â  Â  Â  border-color: var(--button-primary-border-color);
Â  Â  Â  Â  }

Â  Â  Â  Â  .file-browser-controls:not(:has(.actions-group-left)) .search-form-right { margin-left: 0; flex-grow: 1; }
Â  Â  Â  Â  .file-browser-controls:not(:has(.actions-group-left)) .search-form-right input[type="search"] { flex-grow: 1; }
Â  Â  Â  Â  .file-browser-controls:not(:has(.actions-group-left)) .view-toggle { margin-left: auto; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 4px; margin-top: 10px; padding: 2px; display: none; box-sizing: border-box; }
Â  Â  Â  Â  .dark-theme .progress-bar-container { background-color: #495057; }
Â  Â  Â  Â  .progress-bar { display: block; width: 0%; height: 20px; background-color: #007bff; border: 1px solid #0056b3; border-radius: 2px; text-align: center; line-height: 18px; color: white; font-size: 0.8em; font-weight: bold; transition: width 0.1s ease-in-out; box-sizing: border-box; overflow: hidden; }
Â  Â  Â  Â  .dark-theme .progress-bar { background-color: #0056b3; border-color: #003d80; }

Â  Â  Â  Â  #file-container {
Â  Â  Â  Â  Â  Â  max-height: calc(100vh - 320px);Â 
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding-right: 5px;Â 
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  Â  <h1>
Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.isSearchResult && locals.searchQuery) { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æœ‰é—œ "<%= searchQuery %>" çš„æœå°‹çµæœ <% if (locals.viewTargetUsername) { %>(åœ¨ <%= viewTargetUsername %> çš„æ–‡ä»¶ä¸­)<% } else { %>(åœ¨æ‚¨çš„æ–‡ä»¶ä¸­)<% } %>
Â  Â  Â  Â  Â  Â  Â  Â  <% } else if (locals.viewTargetUsername && user.role === 'admin') { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç®¡ç†å“¡è¦–è§’: <%= viewTargetUsername %> çš„æ–‡ä»¶
Â  Â  Â  Â  Â  Â  Â  Â  <% } else { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <%= user.username %> çš„æ–‡ä»¶
Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <div class="header-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <nav>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (user.role === 'admin') { %><a href="/admin" class="nav-button">ç®¡ç†é¢æ¿</a><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/change-password" class="nav-button">ä¿®æ”¹å¯†ç¢¼</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/logout" class="nav-button">ç™»å‡º</a>
Â  Â  Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  Â  Â  Â  Â  <%- include('partials/theme-switcher') %>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <% if (locals.message) { %>
Â  Â  Â  Â  Â  Â  <p class="message <%= (locals.messageType === 'error' || (locals.message && (message.includes('å¤±æ•—') || message.includes('é”™è¯¯') || message.includes('æ²’æœ‰é¸æ“‡æ–‡ä»¶') || message.includes('ç„¡æ•ˆçš„') ))) ? 'error-message' : (locals.messageType === 'success' ? '' : (locals.messageType === 'warning' ? 'warning-message' : '') ) %>"><%= message %></p>
Â  Â  Â  Â  <% } %>

Â  Â  Â  Â  <% if (!locals.isSearchResult) { %>
Â  Â  Â  Â  Â  Â  <div class="current-path">
Â  Â  Â  Â  Â  Â  Â  Â  ç•¶å‰è·¯å¾‘:
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">æ ¹ç›®éŒ„</a>
Â  Â  Â  Â  Â  Â  Â  Â  <%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let pathSegments = currentPath.split('/').filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cumulativePathForLink = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const adminTargetQueryForPath = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : '';
Â  Â  Â  Â  Â  Â  Â  Â  %>
Â  Â  Â  Â  Â  Â  Â  Â  <% pathSegments.forEach(segment => { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% cumulativePathForLink += '/' + segment; %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  / <a href="/files?path=<%= encodeURIComponent(cumulativePathForLink) %><%= adminTargetQueryForPath %>"><%= segment %></a>
Â  Â  Â  Â  Â  Â  Â  Â  <% }); %>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <% } else if (locals.searchQuery) { %>
Â  Â  Â  Â  Â  Â  Â <div class="search-results-info">
Â  Â  Â  Â  Â  Â  Â  Â  æ­£åœ¨é¡¯ç¤ºåŒ…å« "<%= searchQuery %>" çš„æ–‡ä»¶ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">æ¸…é™¤æœç´¢ä¸¦è¿”å›æ ¹ç›®éŒ„</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <% } %>

Â  Â  Â  Â  <div class="file-browser-controls">
Â  Â  Â  Â  Â  Â  <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions-group-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="show-create-textfile-modal-btn">æ–°å»ºæ–‡æœ¬æ–‡ä»¶</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="show-create-folder-modal-btn">å‰µå»ºæ–‡ä»¶å¤¾</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="toggleUploadActionsBtn" class="upload-button-main">ä¸Šå‚³</button>Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  <button type="button" id="toggle-multi-select-btn">å•Ÿç”¨å¤šé¸</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <form action="/files" method="GET" class="control-form search-form-right">
Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.viewTargetUsername && user.role === 'admin') { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="search" name="q" placeholder="æœç´¢..." value="<%= locals.searchQuery || '' %>">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">æœç´¢</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="view-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="listViewBtn">åˆ—è¡¨</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="gridViewBtn">ç¶²æ ¼</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
Â  Â  Â  Â  Â  Â  <div id="upload-actions-container" style="justify-content: flex-start;">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="upload-files-btn">ä¸Šå‚³æ–‡ä»¶</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="upload-folder-btn">ä¸Šå‚³æ–‡ä»¶å¤¾</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="upload-section">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="upload-section-title">ä¸Šå‚³åˆ° "<%= currentPath === '/' ? 'æ ¹ç›®éŒ„' : currentPath.split('/').pop() %>"</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="drop-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="currentPath" value="<%= currentPath %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.viewTargetUsername && user.role === 'admin') { %><input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>"><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="userFiles" name="userFiles" multiple style="display: none;">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="drop-area-text">å°‡æ–‡ä»¶æˆ–æ–‡ä»¶å¤¾æ‹–æ‹½åˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šä¸Šæ–¹æŒ‰éˆ•é¸æ“‡</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="upload-button">ä¸Šå‚³å·²é¸é …ç›®</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="file-list-preview" style="margin-top:10px; text-align:left;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar-container" id="upload-progress-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar" id="upload-progress-bar">0%</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <% } %>

Â  Â  Â  Â  <div id="selection-action-bar">
Â  Â  Â  Â  Â  Â  <span id="selection-count" style="margin-right: 15px;">å·²é¸æ“‡ 0 é …</span>
Â  Â  Â  Â  Â  Â  <button id="action-play-btn" disabled>æ’­æ”¾</button> <button id="action-edit-btn" disabled>ç·¨è¼¯</button>
Â  Â  Â  Â  Â  Â  <button id="action-rename-btn" disabled>é‡å‘½å</button>
Â  Â  Â  Â  Â  Â  <button id="action-move-btn" disabled>ç§»å‹•</button>
Â  Â  Â  Â  Â  Â  <button id="action-download-btn" disabled>ä¸‹è¼‰é¸ä¸­é …</button>
Â  Â  Â  Â  Â  Â  <button id="action-delete-btn" class="secondary" disabled>åˆ é™¤</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <h2><%= locals.isSearchResult ? 'æœç´¢çµæœ' : 'æ–‡ä»¶åˆ—è¡¨' %></h2>
Â  Â  Â  Â  <% if (items.length > 0) { %>
Â  Â  Â  Â  Â  Â  <div id="select-all-container">Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="select-all-checkbox">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="select-all-checkbox">å…¨é¸/å–æ¶ˆå…¨é¸</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  <div id="file-container" class="list-view">Â 
Â  Â  Â  Â  Â  Â  <% if (items.length > 0) { %>
Â  Â  Â  Â  Â  Â  Â  Â  <% const adminTargetQueryForActions = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : ''; %>
Â  Â  Â  Â  Â  Â  Â  Â  <%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formatFileSize = (bytes) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bytes === undefined || bytes === null || isNaN(bytes)) return '--';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bytes === 0) return '0 B';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const k = 1024;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const i = Math.floor(Math.log(bytes) / Math.log(k));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formatDate = (dateString) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!dateString) return '--';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return new Date(dateString).toLocaleDateString('zh-CN', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: '2-digit', day: '2-digit'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Could not format date:", dateString, e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return '--';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  %>
Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% items.forEach(item => { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li data-item-path="<%= item.path %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-entry-selectable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" class="item-checkbox"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-path="<%= item.path %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-encoded-path="<%= item.encodedPath %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-name="<%= item.name %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-encoded-name="<%= item.encodedName %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-is-dir="<%= item.isDir %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-is-playable-video="<%= item.isPlayableVideo || false %>" data-video-type="<%= item.videoType || '' %>" data-raw-name="<%= item.name.replace(/'/g, '\\\'').replace(/"/g, '&quot;') %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-content-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (item.isDir) { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-entry">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-icon-large folder-icon">ğŸ“</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/files?path=<%= item.encodedPath %><%= adminTargetQueryForActions %>" class="file-name"><%= item.name %></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.isSearchResult) { %><span class="file-location-in-search">(ä½æ–¼: <%= (item.path.substring(0, item.path.lastIndexOf('/')) || '/') %>)</span><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-size"></span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-modified"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% } else { // It's a file %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-entry">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ext = item.name.includes('.') ? item.name.substring(item.name.lastIndexOf('.') + 1).toLowerCase() : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let largeIcon = 'ğŸ“„';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isViewableTextFile = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ALLOWED_TEXT_EXTENSIONS.includes('.' + ext) || ALLOWED_TEXT_EXTENSIONS.includes(ext)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isViewableTextFile = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  largeIcon = 'ğŸ“';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (item.isPlayableVideo) { // ä½¿ç”¨ server ç«¯å‚³ä¾†çš„ isPlayableVideo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  largeIcon = 'ğŸ¥';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) { largeIcon = 'ğŸ–¼ï¸'; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (['pdf'].includes(ext)) { largeIcon = 'ğŸ“•';}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-icon-large"><%= largeIcon %></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (item.isPlayableVideo) { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="file-name video-link"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-path="<%= item.encodedPath %>"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-name="<%= item.name %>"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-type="<%= item.videoType %>"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â title="é»æ“Šæ’­æ”¾ <%= item.name %>"><%= item.name %></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% } else if (isViewableTextFile) { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="/view?path=<%= item.encodedPath %><%= adminTargetQueryForActions %>" class="file-name" title="é»æ“ŠæŸ¥çœ‹"><%= item.name %></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% } else { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-name"><%= item.name %></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.isSearchResult) { %><span class="file-location-in-search">(ä½æ–¼: <%= (item.path.substring(0, item.path.lastIndexOf('/')) || '/') %>)</span><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="file-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-size" title="<%= item.size %> bytes"><%= formatFileSize(item.size) %></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-modified"><%= formatDate(item.lastModified) %></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="file-actions-placeholder"></span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="rename-form" id="rename-form-<%= item.encodedName %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form action="/rename" method="POST" class="control-form inline-form">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="currentPath" value="<%= locals.isSearchResult ? (item.path.substring(0, item.path.lastIndexOf('/')) || '/') : currentPath %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="oldPath" value="<%= item.path %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="isDir" value="<%= item.isDir %>">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.viewTargetUsername && user.role === 'admin') { %><input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>"><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" name="newName" placeholder="æ–°åç¨±" value="<%= item.name %>" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">ç¢ºèª</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="secondary" onclick="hideRenameForm('<%= item.encodedName %>'); return false;">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <% }) %>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  <% } else { %>
Â  Â  Â  Â  Â  Â  Â  Â  <p><%= locals.isSearchResult ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶ã€‚' : 'æ­¤æ–‡ä»¶å¤¾ç‚ºç©ºã€‚' %></p>
Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="create-item-modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="close-modal-btn" id="close-create-item-modal-btn">&times;</span>
Â  Â  Â  Â  Â  Â  <h3 id="create-item-modal-title">åˆ›å»ºæ–°é¡¹ç›®</h3>
Â  Â  Â  Â  Â  Â  <form id="create-item-form" method="POST">Â 
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="currentPath" value="<%= currentPath %>">
Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.viewTargetUsername && user.role === 'admin') { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  Â  Â  <% if (locals.csrfToken) { %>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
Â  Â  Â  Â  Â  Â  Â  Â  <% } %>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="create-item-name-input" id="create-item-name-label">åç§°:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="create-item-name-input" name="" required>Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="secondary" id="cancel-create-item-btn">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="confirm-create-item-btn">ç¡®è®¤åˆ›å»º</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="move-modal">
Â  Â  Â  Â  <div class="modal-content"> <span class="close-modal-btn" id="close-move-modal-btn">&times;</span>
Â  Â  Â  Â  Â  Â  <h3>ç§»å‹•é¸ä¸­é …ç›®åˆ°:</h3>
Â  Â  Â  Â  Â  Â  <div id="directory-tree-container">
Â  Â  Â  Â  Â  Â  Â  Â  <p>æ­£åœ¨åŠ è¼‰ç›®éŒ„...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p>å·²é¸æ“‡ç›®æ¨™: <strong id="selected-destination-path">ç„¡</strong></p>
Â  Â  Â  Â  Â  Â  <input type="hidden" id="move-destination-input" value="">
Â  Â  Â  Â  Â  Â  <div class="modal-actions"> <button type="button" class="secondary" id="cancel-move-btn">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="confirm-move-btn" disabled>ç¢ºèªç§»å‹•</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="overwrite-confirm-modal" class="modal" style="display:none; z-index: 1002;">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="close-modal-btn" id="close-overwrite-modal-btn">&times;</span>
Â  Â  Â  Â  Â  Â  <h3>ç¢ºèªæ“ä½œ</h3>
Â  Â  Â  Â  Â  Â  <p id="overwrite-message">ä¸€å€‹åŒåé …ç›®å·²å­˜åœ¨ã€‚æ‚¨è¦è¦†è“‹å®ƒå—ï¼Ÿ</p>
Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="secondary" id="overwrite-abandon-btn">æ”¾æ£„</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="overwrite-confirm-btn">è¦†è“‹</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="video-player-modal">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="close-modal-btn" id="close-video-modal-btn">&times;</span>
Â  Â  Â  Â  Â  Â  <h3 id="video-modal-title" style="margin-bottom: 15px;">æ’­æ”¾è¦–é »</h3>
Â  Â  Â  Â  Â  Â  <video id="html5-video-player" controls controlsList="nodownload" width="100%" style="max-height: 75vh; display: block; background-color: #000;">
Â  Â  Â  Â  Â  Â  Â  Â  <source id="video-source" src="" type="">
Â  Â  Â  Â  Â  Â  Â  Â  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 video æ¨™ç±¤ã€‚
Â  Â  Â  Â  Â  Â  </video>
Â  Â  Â  Â  </div>
Â  Â  </div>


Â  Â  <script src="/theme.js"></script>
Â  Â  <script>
Â  Â  Â  Â  const ALLOWED_TEXT_EXTENSIONS = <%- JSON.stringify(locals.ALLOWED_TEXT_EXTENSIONS || []) %>;
Â  Â  Â  Â  const ALLOWED_VIDEO_EXTENSIONS = <%- JSON.stringify(locals.ALLOWED_VIDEO_EXTENSIONS || []) %>; // å¾ server ç²å–
Â  Â  Â  Â  const CSRF_TOKEN = "<%= locals.csrfToken || '' %>";
Â  Â  Â  Â  const VIEW_TARGET_USERNAME = "<%= locals.viewTargetUsername || '' %>";
Â  Â  Â  Â  const CURRENT_USER_ROLE = "<%= user.role %>";
Â  Â  Â  Â  const CURRENT_PATH_ON_LOAD = "<%= currentPath %>";
Â  Â  Â  Â  const IS_SEARCH_RESULT_VIEW = <%= locals.isSearchResult || false %>;
Â  Â  Â  Â  const EXISTING_ITEM_NAMES_ON_PAGE = <%- JSON.stringify(items.map(item => item.name.toLowerCase())) %>;
Â  Â  Â  Â  const HAS_ITEMS_ON_PAGE = <%= items.length > 0 %>;

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  const fileContainer = document.getElementById('file-container');
Â  Â  Â  Â  Â  Â  const selectAllCheckbox = document.getElementById('select-all-checkbox');
Â  Â  Â  Â  Â  Â  const selectAllContainer = document.getElementById('select-all-container');Â 
Â  Â  Â  Â  Â  Â  const selectionActionBar = document.getElementById('selection-action-bar');
Â  Â  Â  Â  Â  Â  const selectionCountDisplay = document.getElementById('selection-count');
Â  Â  Â  Â  Â  Â  const actionPlayBtn = document.getElementById('action-play-btn'); // æ–°å¢
Â  Â  Â  Â  Â  Â  const actionEditBtn = document.getElementById('action-edit-btn');
Â  Â  Â  Â  Â  Â  const actionRenameBtn = document.getElementById('action-rename-btn');
Â  Â  Â  Â  Â  Â  const actionMoveBtn = document.getElementById('action-move-btn');
Â  Â  Â  Â  Â  Â  const actionDownloadBtn = document.getElementById('action-download-btn');
Â  Â  Â  Â  Â  Â  const actionDeleteBtn = document.getElementById('action-delete-btn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const moveModal = document.getElementById('move-modal');
Â  Â  Â  Â  Â  Â  const closeMoveModalBtn = document.getElementById('close-move-modal-btn');
Â  Â  Â  Â  Â  Â  const directoryTreeContainer = document.getElementById('directory-tree-container');
Â  Â  Â  Â  Â  Â  const confirmMoveBtn = document.getElementById('confirm-move-btn');
Â  Â  Â  Â  Â  Â  const cancelMoveBtn = document.getElementById('cancel-move-btn');
Â  Â  Â  Â  Â  Â  const selectedDestinationPathDisplay = document.getElementById('selected-destination-path');
Â  Â  Â  Â  Â  Â  const moveDestinationInput = document.getElementById('move-destination-input');
Â  Â  Â  Â  Â  Â  let currentDirectoryTree = [];

Â  Â  Â  Â  Â  Â  const toggleUploadActionsBtn = document.getElementById('toggleUploadActionsBtn');
Â  Â  Â  Â  Â  Â  const uploadActionsContainer = document.getElementById('upload-actions-container');
Â  Â  Â  Â  Â  Â  const uploadFilesBtn = document.getElementById('upload-files-btn');
Â  Â  Â  Â  Â  Â  const uploadFolderBtn = document.getElementById('upload-folder-btn');
Â  Â  Â  Â  Â  Â  const uploadSection = document.getElementById('upload-section');
Â  Â  Â  Â  Â  Â  const userFilesInput = document.getElementById('userFiles');
Â  Â  Â  Â  Â  Â  const dropAreaText = document.getElementById('drop-area-text');
Â  Â  Â  Â  Â  Â  const uploadForm = document.getElementById('upload-form');
Â  Â  Â  Â  Â  Â  const uploadProgressContainer = document.getElementById('upload-progress-container');
Â  Â  Â  Â  Â  Â  const uploadProgressBar = document.getElementById('upload-progress-bar');
Â  Â  Â  Â  Â  Â  const fileListPreview = document.getElementById('file-list-preview');
Â  Â  Â  Â  Â  Â  const uploadButton = document.getElementById('upload-button');Â 
Â  Â  Â  Â  Â  Â  const dropArea = document.getElementById('drop-area');

Â  Â  Â  Â  Â  Â  const overwriteModal = document.getElementById('overwrite-confirm-modal');
Â  Â  Â  Â  Â  Â  const overwriteMessage = document.getElementById('overwrite-message');
Â  Â  Â  Â  Â  Â  const overwriteConfirmBtn = document.getElementById('overwrite-confirm-btn');
Â  Â  Â  Â  Â  Â  const overwriteAbandonBtn = document.getElementById('overwrite-abandon-btn');
Â  Â  Â  Â  Â  Â  const closeOverwriteModalBtn = document.getElementById('close-overwrite-modal-btn');

Â  Â  Â  Â  Â  Â  const toggleMultiSelectBtn = document.getElementById('toggle-multi-select-btn');
Â  Â  Â  Â  Â  Â  let multiSelectModeActive = false;
Â  Â  Â  Â  Â  Â  let currentSingleSelectedItem = null;

Â  Â  Â  Â  Â  Â  // æ–°å¢: è¦–é »æ’­æ”¾å™¨ç›¸é—œå…ƒç´ 
Â  Â  Â  Â  Â  Â  const videoPlayerModal = document.getElementById('video-player-modal');
Â  Â  Â  Â  Â  Â  const html5VideoPlayer = document.getElementById('html5-video-player');
Â  Â  Â  Â  Â  Â  const videoSourceElement = document.getElementById('video-source');
Â  Â  Â  Â  Â  Â  const videoModalTitle = document.getElementById('video-modal-title');
Â  Â  Â  Â  Â  Â  const closeVideoModalBtn = document.getElementById('close-video-modal-btn');


Â  Â  Â  Â  Â  Â  function clearSingleSelection() {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSingleSelectedItem && currentSingleSelectedItem.element) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSingleSelectedItem.element.classList.remove('single-selected-item');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  currentSingleSelectedItem = null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function updateMultiSelectModeUI() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!fileContainer || !toggleMultiSelectBtn) return;

Â  Â  Â  Â  Â  Â  Â  Â  if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.add('multi-select-mode-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleMultiSelectBtn.textContent = 'å–æ¶ˆå¤šé¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectAllContainer && HAS_ITEMS_ON_PAGE) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectAllContainer.classList.add('visible-in-multiselect');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.remove('multi-select-mode-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleMultiSelectBtn.textContent = 'å•Ÿç”¨å¤šé¸';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectAllContainer) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectAllContainer.classList.remove('visible-in-multiselect');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.item-checkbox:checked').forEach(cb => cb.checked = false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectAllCheckbox) selectAllCheckbox.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (toggleMultiSelectBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  toggleMultiSelectBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  multiSelectModeActive = !multiSelectModeActive;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMultiSelectModeUI();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function getCheckboxSelectedItems() {
Â  Â  Â  Â  Â  Â  Â  Â  const currentCheckboxes = document.querySelectorAll('#file-container .item-checkbox');Â 
Â  Â  Â  Â  Â  Â  Â  Â  const selected = [];
Â  Â  Â  Â  Â  Â  Â  Â  currentCheckboxes.forEach((cb) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cb.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  path: cb.dataset.path, encodedPath: cb.dataset.encodedPath,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: cb.dataset.name, encodedName: cb.dataset.encodedName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDir: cb.dataset.isDir === 'true', rawName: cb.dataset.rawName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlayableVideo: cb.dataset.isPlayableVideo === 'true', // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoType: cb.dataset.videoType, // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element: cb.closest('li')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return selected;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function updateSelectionActions() {
Â  Â  Â  Â  Â  Â  Â  Â  let count = 0;
Â  Â  Â  Â  Â  Â  Â  Â  let itemsForActions = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  let isSingleFileEditable = false;
Â  Â  Â  Â  Â  Â  Â  Â  let isSingleFilePlayableVideo = false; // æ–°å¢

Â  Â  Â  Â  Â  Â  Â  Â  if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const checkboxSelectedItems = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count = checkboxSelectedItems.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsForActions = checkboxSelectedItems;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (count === 1 && itemsForActions[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!itemsForActions[0].isDir) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const fileName = itemsForActions[0].name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const fileExt = fileName.includes('.') ? fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase() : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (ALLOWED_TEXT_EXTENSIONS.includes('.' + fileExt) || ALLOWED_TEXT_EXTENSIONS.includes(fileExt)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isSingleFileEditable = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (itemsForActions[0].isPlayableVideo) { // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSingleFilePlayableVideo = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsForActions.push(currentSingleSelectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!currentSingleSelectedItem.isDir) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fileName = currentSingleSelectedItem.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fileExt = fileName.includes('.') ? fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase() : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (ALLOWED_TEXT_EXTENSIONS.includes('.' + fileExt) || ALLOWED_TEXT_EXTENSIONS.includes(fileExt)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSingleFileEditable = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentSingleSelectedItem.isPlayableVideo) { // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSingleFilePlayableVideo = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectionActionBar.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectionCountDisplay.textContent = `å·²é¸æ“‡ ${count} é …`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectionActionBar.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(actionPlayBtn) actionPlayBtn.disabled = !(count === 1 && isSingleFilePlayableVideo); // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  if(actionEditBtn) actionEditBtn.disabled = !(count === 1 && isSingleFileEditable);
Â  Â  Â  Â  Â  Â  Â  Â  if(actionRenameBtn) actionRenameBtn.disabled = !(count === 1);
Â  Â  Â  Â  Â  Â  Â  Â  if(actionMoveBtn) actionMoveBtn.disabled = !(count > 0);
Â  Â  Â  Â  Â  Â  Â  Â  if(actionDownloadBtn) actionDownloadBtn.disabled = !(count > 0);
Â  Â  Â  Â  Â  Â  Â  Â  if(actionDeleteBtn) actionDeleteBtn.disabled = !(count > 0);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.querySelectorAll('#file-container .item-checkbox').forEach((checkbox) => {
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (multiSelectModeActive) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (selectAllCheckbox && selectAllContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  selectAllCheckbox.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentCheckboxes = document.querySelectorAll('#file-container .item-checkbox');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCheckboxes.forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cb.checked !== e.target.checked) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = e.target.checked;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (fileContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.querySelectorAll('ul > li .file-content-wrapper').forEach(contentWrapper => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contentWrapper.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listItem = contentWrapper.closest('li');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!listItem) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const checkbox = listItem.querySelector('.item-checkbox');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!checkbox) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¦‚æœé»æ“Šçš„æ˜¯æ’­æ”¾éˆæ¥ï¼Œå‰‡ç”±å…¶è‡ªèº«çš„äº‹ä»¶è™•ç†å™¨è™•ç†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.target.classList.contains('video-link') || event.target.closest('.video-link')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.target.tagName === 'A' || event.target.closest('a') ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.target.classList.contains('item-checkbox') ||Â 
Â  Â  Â  Â  Â  _TAG_TARGET_CURSOR_
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.target.closest('.rename-form')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  path: checkbox.dataset.path, encodedPath: checkbox.dataset.encodedPath,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: checkbox.dataset.name, encodedName: checkbox.dataset.encodedName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDir: checkbox.dataset.isDir === 'true', rawName: checkbox.dataset.rawName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlayableVideo: checkbox.dataset.isPlayableVideo === 'true', // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoType: checkbox.dataset.videoType, // æ–°å¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element: listItemÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (multiSelectModeActive) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = !checkbox.checked;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentSingleSelectedItem && currentSingleSelectedItem.element === listItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSingleSelectedItem = itemData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listItem.classList.add('single-selected-item');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.addEventListener('click', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.target.closest('li') === null && (event.target.isSameNode(fileContainer) || event.target.tagName === 'UL')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // æ–°å¢: è™•ç†è¦–é »æ’­æ”¾éˆæ¥é»æ“Š
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.video-link').forEach(link => {
Â  Â  Â  Â  Â  Â  Â  Â  link.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const encodedPath = this.dataset.path;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const videoName = this.dataset.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const videoType = this.dataset.type;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openVideoPlayer(encodedPath, videoName, videoType);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // æ–°å¢: è™•ç†é¸æ“‡æ“ä½œæ¬„ä¸­çš„æ’­æ”¾æŒ‰éˆ•
Â  Â  Â  Â  Â  Â  if (actionPlayBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionPlayBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionPlayBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemToPlay = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive && currentSingleSelectedItem && currentSingleSelectedItem.isPlayableVideo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemToPlay = currentSingleSelectedItem;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selected = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selected.length === 1 && selected[0].isPlayableVideo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemToPlay = selected[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemToPlay) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openVideoPlayer(itemToPlay.encodedPath, itemToPlay.name, itemToPlay.videoType);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â if (actionEditBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionEditBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionEditBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemToEdit = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemToEdit = currentSingleSelectedItem;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selected = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selected.length === 1) itemToEdit = selected[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemToEdit && !itemToEdit.isDir) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let url = `/edit?path=${itemToEdit.encodedPath}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url += `&targetUsername=${encodeURIComponent(VIEW_TARGET_USERNAME)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (actionRenameBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionRenameBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionRenameBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemToRename = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemToRename = currentSingleSelectedItem;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selected = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selected.length === 1) itemToRename = selected[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemToRename) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showRenameForm(itemToRename.encodedName, itemToRename.name, itemToRename.isDir);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (actionDownloadBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionDownloadBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionDownloadBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemsToDownload = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToDownload.push(currentSingleSelectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToDownload = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemsToDownload.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("è«‹é¸æ“‡è¦ä¸‹è¼‰çš„é …ç›®ã€‚"); return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemsToDownload.length === 1 && !itemsToDownload[0].isDir) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let url = `/download?path=${itemsToDownload[0].encodedPath}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url += `&targetUsername=${encodeURIComponent(VIEW_TARGET_USERNAME)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempLink.href = url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempLink.setAttribute('download', itemsToDownload[0].name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempLink.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(tempLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempLink.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(tempLink);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const form = document.createElement('form');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.method = 'POST';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.action = '/download-archive';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsInput.type = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsInput.name = 'items';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsForPayload = itemsToDownload.map(item => ({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  path: item.path, name: item.name, isDir: item.isDirÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsInput.value = JSON.stringify(itemsForPayload);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.appendChild(itemsInput);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetUserInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetUserInput.type = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetUserInput.name = 'targetUsername';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetUserInput.value = VIEW_TARGET_USERNAME;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.appendChild(targetUserInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (CSRF_TOKEN) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const csrfInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csrfInput.type = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csrfInput.name = '_csrf';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csrfInput.value = CSRF_TOKEN;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  form.appendChild(csrfInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(form);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { form.submit(); } catch (e) { console.error("è¡¨å–®æäº¤éŒ¯èª¤:", e); alert("è§¸ç™¼ä¸‹è¼‰æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚"); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (form.parentNode === document.body) { document.body.removeChild(form); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (actionDeleteBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionDeleteBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionDeleteBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemsToDelete = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToDelete.push(currentSingleSelectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToDelete = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemsToDelete.length === 0) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemNames = itemsToDelete.map(item => item.rawName).join(', ');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${itemsToDelete.length} å€‹é …ç›® (${itemNames}) å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ï¼`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let allSucceeded = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let reloadPage = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errors = [];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const item of itemsToDelete) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let deleteUrl = `/delete?path=${item.encodedPath}&isDir=${item.isDir}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deleteUrl += `&targetUsername=${encodeURIComponent(VIEW_TARGET_USERNAME)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(deleteUrl, {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET', // å‡è¨­ DELETE ä¹Ÿæ˜¯ GET è«‹æ±‚ï¼Œæ ¹æ“šæ‚¨çš„ server.js
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.redirected || (response.headers.get("Content-Type") && response.headers.get("Content-Type").includes("application/json"))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reloadPage = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSucceeded = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(result.message || `åˆªé™¤ ${item.name} å¤±æ•—`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reloadPage = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reloadPage = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSucceeded = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorMsg = `åˆªé™¤ ${item.name} å¤±æ•— (ç‹€æ…‹: ${response.status})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errResult = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(errResult.message) errorMsg = errResult.message;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) { /* ignore if not json */ }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('åˆªé™¤å¤±æ•—:', item.name, response.status, await response.text());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allSucceeded = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errors.push(`åˆªé™¤ ${item.name} æ™‚ç™¼ç”Ÿå®¢æˆ¶ç«¯éŒ¯èª¤`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('åˆªé™¤é …ç›®æ™‚å‡ºéŒ¯:', item.name, error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (errors.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("éƒ¨åˆ†æˆ–å…¨éƒ¨é …ç›®åˆªé™¤å¤±æ•—ï¼š\n" + errors.join("\n"));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (allSucceeded) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("é¸ä¸­é …ç›®å·²æˆåŠŸåˆªé™¤ã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (reloadPage || !allSucceeded) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â clearSingleSelection();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(selectAllCheckbox) selectAllCheckbox.checked = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('#file-container .item-checkbox').forEach(cb => cb.checked = false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (actionMoveBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  actionMoveBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionMoveBtn.disabled) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemsToMove = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToMove.push(currentSingleSelectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemsToMove = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemsToMove.length === 0) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moveDestinationInput.value = ''; selectedDestinationPathDisplay.textContent = 'ç„¡';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmMoveBtn.disabled = true; directoryTreeContainer.innerHTML = '<p>æ­£åœ¨åŠ è¼‰ç›®éŒ„...</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moveModal.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let fetchUrl = '/api/directories'; let queryParams = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') queryParams.push(`targetUsername=${encodeURIComponent(VIEW_TARGET_USERNAME)}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pathsToExclude = itemsToMove.flatMap(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.isDir) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [item.path];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pathsToExclude.length > 0) queryParams.push(`excludePaths=${encodeURIComponent(pathsToExclude.join(','))}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (queryParams.length > 0) fetchUrl += `?${queryParams.join('&')}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(fetchUrl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`ç„¡æ³•ç²å–ç›®éŒ„åˆ—è¡¨: ${response.statusText}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDirectoryTree = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderDirectoryTree(currentDirectoryTree, directoryTreeContainer, itemsToMove);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('ç²å–ç›®éŒ„æ¨¹æ™‚å‡ºéŒ¯:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  directoryTreeContainer.innerHTML = `<p style="color:red;">åŠ è¼‰ç›®éŒ„å¤±æ•—: ${error.message}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function renderDirectoryTree(nodes, container, itemsBeingMoved) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = ''; const ul = document.createElement('ul');
Â  Â  Â  Â  Â  Â  Â  Â  const rootLi = document.createElement('li');Â 
Â  Â  Â  Â  Â  Â  Â  Â  rootLi.textContent = 'æ ¹ç›®éŒ„ (/)';
Â  Â  Â  Â  Â  Â  Â  Â  rootLi.dataset.path = '/';Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let isRootInvalid = itemsBeingMoved.some(item => item.path.substring(0, item.path.lastIndexOf('/')) === '' && item.path !== '/');Â 

Â  Â  Â  Â  Â  Â  Â  Â  rootLi.addEventListener('click', (e) => selectDestination(e.target, '/'));
Â  Â  Â  Â  Â  Â  Â  Â  ul.appendChild(rootLi);

Â  Â  Â  Â  Â  Â  Â  Â  function buildTree(dirItems, parentUl, currentParentPath) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dirItems.forEach(dirNode => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isMovingThisDirOrChild = itemsBeingMoved.some(movedItem =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  movedItem.isDir && (dirNode.path === movedItem.path || dirNode.path.startsWith(movedItem.path + '/'))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCurrentParent = itemsBeingMoved.every(movedItem => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const movedItemParentPath = movedItem.path.substring(0, movedItem.path.lastIndexOf('/')) || '/';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return movedItemParentPath === dirNode.path;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isMovingThisDirOrChild) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = dirNode.name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.dataset.path = dirNode.path;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isCurrentParent && itemsBeingMoved.length === 1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.style.opacity = "0.5";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.style.pointerEvents = "none";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â li.addEventListener('click', (e) => { e.stopPropagation(); selectDestination(e.target, dirNode.path); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parentUl.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dirNode.children && dirNode.children.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nestedUl = document.createElement('ul');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.appendChild(nestedUl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buildTree(dirNode.children, nestedUl, dirNode.path);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  buildTree(nodes, ul, '/');Â 
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(ul);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function selectDestination(targetElement, path) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('#directory-tree-container li.selected-dir').forEach(el => el.classList.remove('selected-dir'));
Â  Â  Â  Â  Â  Â  Â  Â  targetElement.classList.add('selected-dir');
Â  Â  Â  Â  Â  Â  Â  Â  selectedDestinationPathDisplay.textContent = path; moveDestinationInput.value = path;
Â  Â  Â  Â  Â  Â  Â  Â  confirmMoveBtn.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (closeMoveModalBtn) closeMoveModalBtn.onclick = () => moveModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  if (cancelMoveBtn) cancelMoveBtn.onclick = () => moveModal.style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (confirmMoveBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  confirmMoveBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let selectedToMove = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!multiSelectModeActive && currentSingleSelectedItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedToMove.push(currentSingleSelectedItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (multiSelectModeActive) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedToMove = getCheckboxSelectedItems();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const destinationPath = moveDestinationInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectedToMove.length === 0 || (destinationPath === null || destinationPath === undefined) ) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('è«‹é¸æ“‡è¦ç§»å‹•çš„é …ç›®å’Œç›®æ¨™æ–‡ä»¶å¤¾ã€‚'); return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const item of selectedToMove) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemParentPath = item.path.substring(0, item.path.lastIndexOf('/')) || '/';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (itemParentPath === destinationPath) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`é …ç›® "${item.name}" å·²ç¶“åœ¨ç›®æ¨™æ–‡ä»¶å¤¾ "${destinationPath === '/' ? 'æ ¹ç›®éŒ„' : destinationPath}" ä¸­ã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.isDir && (destinationPath === item.path || destinationPath.startsWith(item.path + '/'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`ä¸èƒ½å°‡æ–‡ä»¶å¤¾ "${item.name}" ç§»å‹•åˆ°å…¶è‡ªèº«æˆ–å…¶å­æ–‡ä»¶å¤¾ä¸­ã€‚`); return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const payload = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sourcePaths: selectedToMove.map(item => item.path),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destinationPath: destinationPath,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  _TAG_TARGET_CURSOR_
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (CSRF_TOKEN) payload._csrf = CSRF_TOKEN;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') payload.targetUsername = VIEW_TARGET_USERNAME;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/move-items', {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json', },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok && result.success) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message || 'é …ç›®ç§»å‹•æˆåŠŸï¼');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = result.redirectUrl || window.location.pathname + window.location.search;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alert(`ç§»å‹•å¤±æ•—: ${result.message || 'ä¼ºæœå™¨ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚'}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('ç§»å‹•é …ç›®æ™‚å‡ºéŒ¯:', error);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorMsg = `ç§»å‹•é …ç›®æ™‚ç™¼ç”Ÿå®¢æˆ¶ç«¯éŒ¯èª¤ã€‚`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error instanceof SyntaxError) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg += " ä¼ºæœå™¨å¯èƒ½è¿”å›äº†éé æœŸçš„å›æ‡‰æ ¼å¼ã€‚";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (error.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMsg += ` ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(errorMsg);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  moveModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function showOverwriteConfirmationModal(itemName) {
Â  Â  Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!overwriteModal || !overwriteMessage || !overwriteConfirmBtn || !overwriteAbandonBtn || !closeOverwriteModalBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Overwrite modal elements not found!");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve('abandon');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteMessage.textContent = `ä¸€å€‹åç‚º "${itemName}" çš„é …ç›®å·²å­˜åœ¨æ–¼ç•¶å‰ç›®éŒ„ã€‚æ‚¨è¦è¦†è“‹å®ƒå—ï¼Ÿ`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteModal.style.display = 'block';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const handleConfirm = () => { cleanupAndResolve('overwrite'); };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const handleAbandon = () => { cleanupAndResolve('abandon'); };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  function cleanupAndResolve(decision) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteConfirmBtn.removeEventListener('click', handleConfirm);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteAbandonBtn.removeEventListener('click', handleAbandon);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeOverwriteModalBtn.removeEventListener('click', handleAbandon);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(decision);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteConfirmBtn.addEventListener('click', handleConfirm, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  overwriteAbandonBtn.addEventListener('click', handleAbandon, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeOverwriteModalBtn.addEventListener('click', handleAbandon, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (toggleUploadActionsBtn && uploadActionsContainer && uploadSection) {
Â  Â  Â  Â  Â  Â  Â  Â  toggleUploadActionsBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isActionsHidden = uploadActionsContainer.style.display === 'none' || uploadActionsContainer.style.display === '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadActionsContainer.style.display = isActionsHidden ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isActionsHidden) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadSection.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleUploadActionsBtn.textContent = 'ä¸Šå‚³';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(userFilesInput) userFilesInput.value = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(fileListPreview) fileListPreview.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(uploadButton) uploadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(uploadProgressContainer) uploadProgressContainer.style.display = 'none';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleUploadActionsBtn.textContent = 'å–æ¶ˆä¸Šå‚³æ“ä½œ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (uploadFilesBtn && uploadSection && userFilesInput && dropAreaText && fileListPreview && uploadButton) {
Â  Â  Â  Â  Â  Â  Â  Â  uploadFilesBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('webkitdirectory');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('directory');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('multiple', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dropAreaText) dropAreaText.textContent = 'å°‡æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤è™•é€²è¡Œä¸Šå‚³ï¼Œæˆ–é»æ“Šé¸æ“‡æ–‡ä»¶ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (toggleUploadActionsBtn) toggleUploadActionsBtn.textContent = 'å–æ¶ˆä¸Šå‚³æ“ä½œ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!uploadActionsContainer || uploadActionsContainer.style.display === 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(uploadActionsContainer) uploadActionsContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.value = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileListPreview.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.style.display = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.click();Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (uploadFolderBtn && uploadSection && userFilesInput && dropAreaText && fileListPreview && uploadButton) {
Â  Â  Â  Â  Â  Â  Â  Â  uploadFolderBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('webkitdirectory', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('directory', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('multiple');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dropAreaText) dropAreaText.textContent = 'å°‡æ–‡ä»¶å¤¾æ‹–æ‹½åˆ°æ­¤è™•é€²è¡Œä¸Šå‚³ï¼Œæˆ–é»æ“Šé¸æ“‡æ–‡ä»¶å¤¾ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadSection.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (toggleUploadActionsBtn) toggleUploadActionsBtn.textContent = 'å–æ¶ˆä¸Šå‚³æ“ä½œ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!uploadActionsContainer || uploadActionsContainer.style.display === 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(uploadActionsContainer) uploadActionsContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.value = null;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileListPreview.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.click();Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (uploadForm && userFilesInput) {
Â  Â  Â  Â  Â  Â  Â  Â  uploadForm.addEventListener('submit', async function(event) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userFilesInput.files.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('è«‹é¸æ“‡è¦ä¸Šå‚³çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¾ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalFiles = Array.from(userFilesInput.files);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalFilesToUpload = [];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let processedTopLevelItems = new Set();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const file of originalFiles) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let nameToCheck = file.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isTopLevelItem = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (file.webkitRelativePath) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pathParts = file.webkitRelativePath.split('/');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nameToCheck = pathParts[0];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pathParts.length > 1) isTopLevelItem = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (EXISTING_ITEM_NAMES_ON_PAGE.includes(nameToCheck.toLowerCase()) && !processedTopLevelItems.has(nameToCheck.toLowerCase())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processedTopLevelItems.add(nameToCheck.toLowerCase());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userDecision = await showOverwriteConfirmationModal(nameToCheck);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userDecision === 'overwrite') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalFiles.forEach(f => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if ((f.webkitRelativePath && f.webkitRelativePath.startsWith(nameToCheck + '/')) || f.name === nameToCheck) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!finalFilesToUpload.includes(f)) finalFilesToUpload.push(f);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Skipping ${nameToCheck} and its contents due to user choice.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (!EXISTING_ITEM_NAMES_ON_PAGE.includes(nameToCheck.toLowerCase())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!finalFilesToUpload.includes(file)) finalFilesToUpload.push(file);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(isTopLevelItem) processedTopLevelItems.add(nameToCheck.toLowerCase());Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (processedTopLevelItems.has(nameToCheck.toLowerCase()) && finalFilesToUpload.some(f => (f.webkitRelativePath || f.name).startsWith(nameToCheck))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!finalFilesToUpload.includes(file)) finalFilesToUpload.push(file);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (finalFilesToUpload.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('æ²’æœ‰æ–‡ä»¶æº–å‚™ä¸Šå‚³ï¼ˆå¯èƒ½æ‰€æœ‰è¡çªçš„æ–‡ä»¶éƒ½å·²è¢«æ”¾æ£„ï¼‰ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadProgressContainer) uploadProgressContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadButton) uploadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fileListPreview) fileListPreview.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userFilesInput) userFilesInput.value = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formData = new FormData();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentPathInput = uploadForm.querySelector('input[name="currentPath"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentPathInput) formData.append('currentPath', currentPathInput.value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetUsernameInput = uploadForm.querySelector('input[name="targetUsername"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (targetUsernameInput && targetUsernameInput.value) formData.append('targetUsername', targetUsernameInput.value);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const csrfInput = uploadForm.querySelector('input[name="_csrf"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (csrfInput) formData.append('_csrf', csrfInput.value);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const file of finalFilesToUpload) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formData.append('userFiles', file, file.webkitRelativePath || file.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const xhr = new XMLHttpRequest();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.open('POST', uploadForm.action, true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadProgressContainer && uploadProgressBar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadProgressContainer.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadProgressBar.style.width = '0%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadProgressBar.textContent = '0%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.upload.onprogress = function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.lengthComputable) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const percentComplete = Math.round((event.loaded / event.total) * 100);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadProgressBar) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadProgressBar.style.width = percentComplete + '%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadProgressBar.textContent = percentComplete + '%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.onload = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadProgressContainer) uploadProgressContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (xhr.status >= 200 && xhr.status < 300) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let responseData = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { responseData = JSON.parse(xhr.responseText); } catch (e) { /* Ignore */ }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (responseData && responseData.redirectUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = responseData.redirectUrl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (xhr.responseURL && xhr.responseURL !== xhr.openUrl && xhr.responseURL.includes('/files')) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = xhr.responseURL;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert( (responseData && responseData.message) || 'ä¸Šå‚³æˆåŠŸï¼é é¢å°‡åˆ·æ–°ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.reload();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage = `ä¸Šå‚³å¤±æ•—ã€‚ä¼ºæœå™¨éŸ¿æ‡‰: ${xhr.status}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const responseJson = JSON.parse(xhr.responseText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (responseJson && responseJson.message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = responseJson.message;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(xhr.responseText && xhr.responseText.length < 500) errorMessage = xhr.responseText;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Upload failed:', xhr.status, xhr.responseText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.onerror = function(e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadProgressContainer) uploadProgressContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('ä¸Šå‚³éç¨‹ä¸­ç™¼ç”Ÿç¶²çµ¡éŒ¯èª¤ã€‚è«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥å’Œæœå‹™å™¨ç‹€æ…‹ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Upload network error:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.openUrl = uploadForm.action;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xhr.send(formData);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (dropArea && userFilesInput && fileListPreview && uploadSection && dropAreaText && uploadActionsContainer && toggleUploadActionsBtn) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dropArea.addEventListener(eventName, preventDefaults, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.addEventListener(eventName, preventDefaults, false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  dropArea.addEventListener('dragenter', () => dropArea.classList.add('highlight'), false);
Â  Â  Â  Â  Â  Â  Â  Â  dropArea.addEventListener('dragover', () => dropArea.classList.add('highlight'), false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  dropArea.addEventListener('dragleave', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.relatedTarget === null || !dropArea.contains(e.relatedTarget)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dropArea.classList.remove('highlight');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  dropArea.addEventListener('drop', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preventDefaults(e);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dropArea.classList.remove('highlight');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dt = e.dataTransfer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const files = dt.files;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isLikelyFolderDrop = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dt.items && dt.items.length > 0 && typeof dt.items[0].webkitGetAsEntry === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const entry = dt.items[0].webkitGetAsEntry();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (entry && entry.isDirectory) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLikelyFolderDrop = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (files.length > 0 && files[0].webkitRelativePath) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firstFileRelativePath = files[0].webkitRelativePath;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (firstFileRelativePath && firstFileRelativePath.includes('/')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â isLikelyFolderDrop = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (files.length > 1 && Array.from(files).every(f => f.webkitRelativePath.startsWith(firstFileRelativePath.split('/')[0]))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLikelyFolderDrop = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLikelyFolderDrop) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('webkitdirectory', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('directory', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('multiple');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dropAreaText) dropAreaText.textContent = 'å·²æ‹–å…¥æ–‡ä»¶å¤¾ï¼Œæº–å‚™ä¸Šå‚³ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('webkitdirectory');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.removeAttribute('directory');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.setAttribute('multiple', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dropAreaText) dropAreaText.textContent = 'å·²æ‹–å…¥æ–‡ä»¶ï¼Œæº–å‚™ä¸Šå‚³ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.files = files;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFileListPreviewOnDrop();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadSection.style.display = 'block';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (uploadActionsContainer.style.display === 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â uploadActionsContainer.style.display = 'flex';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (toggleUploadActionsBtn) toggleUploadActionsBtn.textContent = 'å–æ¶ˆä¸Šå‚³æ“ä½œ';
Â  Â  Â  Â  Â  Â  Â  Â  }, false);

Â  Â  Â  Â  Â  Â  Â  Â  userFilesInput.addEventListener('change', updateFileListPreviewOnDrop);Â 

Â  Â  Â  Â  Â  Â  Â  Â  function updateFileListPreviewOnDrop() {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!fileListPreview || !userFilesInput || !uploadButton) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileListPreview.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const files = userFilesInput.files;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (files.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const list = document.createElement('ul');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.style.listStyleType = 'none'; list.style.paddingLeft = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isDirectoryUpload = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userFilesInput.hasAttribute('webkitdirectory') || (files[0] && files[0].webkitRelativePath && files[0].webkitRelativePath.includes('/'))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDirectoryUpload = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDirectoryUpload) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const folderName = files[0].webkitRelativePath.split('/')[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listItem = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listItem.textContent = `æ–‡ä»¶å¤¾: ${folderName} (${files.length} å€‹æ–‡ä»¶)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listItem.style.fontSize = '0.9em'; listItem.style.fontWeight = 'bold';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(listItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < files.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const listItem = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listItem.textContent = files[i].name + (files[i].size ? ` (${(files[i].size / 1024).toFixed(1)} KB)` : '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listItem.style.fontSize = '0.9em';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(listItem);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileListPreview.appendChild(list);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uploadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (userFilesInput && uploadButton && userFilesInput.files.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â uploadButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const listViewBtn = document.getElementById('listViewBtn');
Â  Â  Â  Â  Â  Â  const gridViewBtn = document.getElementById('gridViewBtn');
Â  Â  Â  Â  Â  Â  if (fileContainer && listViewBtn && gridViewBtn) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  function toggleView(viewType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCurrentlyMultiSelect = fileContainer.classList.contains('multi-select-mode-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.remove('list-view', 'grid-view');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (viewType === 'grid') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.add('grid-view');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gridViewBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listViewBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('fileView', 'grid');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.add('list-view');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listViewBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gridViewBtn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('fileView', 'list');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isCurrentlyMultiSelect) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileContainer.classList.add('multi-select-mode-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearSingleSelection();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateSelectionActions();Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const preferredView = localStorage.getItem('fileView') || 'list';Â 
Â  Â  Â  Â  Â  Â  Â  Â  toggleView(preferredView);Â 
Â  Â  Â  Â  Â  Â  Â  Â  listViewBtn.addEventListener('click', () => toggleView('list'));
Â  Â  Â  Â  Â  Â  Â  Â  gridViewBtn.addEventListener('click', () => toggleView('grid'));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const createItemModal = document.getElementById('create-item-modal');
Â  Â  Â  Â  Â  Â  const closeCreateItemModalBtn = document.getElementById('close-create-item-modal-btn');
Â  Â  Â  Â  Â  Â  const cancelCreateItemBtn = document.getElementById('cancel-create-item-btn');
Â  Â  Â  Â  Â  Â  const createItemForm = document.getElementById('create-item-form');
Â  Â  Â  Â  Â  Â  const createItemModalTitle = document.getElementById('create-item-modal-title');
Â  Â  Â  Â  Â  Â  const createItemNameInput = document.getElementById('create-item-name-input');
Â  Â  Â  Â  Â  Â  const createItemNameLabel = document.getElementById('create-item-name-label');
Â  Â  Â  Â  Â  Â  const showCreateTextfileModalBtn = document.getElementById('show-create-textfile-modal-btn');
Â  Â  Â  Â  Â  Â  const showCreateFolderModalBtn = document.getElementById('show-create-folder-modal-btn');

Â  Â  Â  Â  Â  Â  function openCreateItemModal(type) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!createItemModal || !createItemForm || !createItemModalTitle || !createItemNameLabel || !createItemNameInput) return;
Â  Â  Â  Â  Â  Â  Â  Â  createItemForm.reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const currentPathForCreation = IS_SEARCH_RESULT_VIEW ? '/' : CURRENT_PATH_ON_LOAD;
Â  Â  Â  Â  Â  Â  Â  Â  const currentPathInputInForm = createItemForm.querySelector('input[name="currentPath"]');
Â  Â  Â  Â  Â  Â  Â  Â  if (currentPathInputInForm) currentPathInputInForm.value = currentPathForCreation;


Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'textfile') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemModalTitle.textContent = 'æ–°å»ºæ–‡æœ¬æ–‡ä»¶';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameLabel.textContent = 'æ–‡ä»¶å (ä¾‹å¦‚: mydoc.txt):';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameInput.name = 'newFileName';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameInput.placeholder = 'ä¾‹å¦‚: notes.txt, script.js';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemForm.action = '/create-text-file';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'folder') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemModalTitle.textContent = 'åˆ›å»ºæ–°æ–‡ä»¶å¤¹';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameLabel.textContent = 'æ–‡ä»¶å¤¹åç§°:';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameInput.name = 'folderName';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemNameInput.placeholder = 'ä¾‹å¦‚: æˆ‘çš„æ–‡æ¡£';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createItemForm.action = '/create-folder';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const targetUsernameHiddenInput = createItemForm.querySelector('input[name="targetUsername"]');
Â  Â  Â  Â  Â  Â  Â  Â  if (targetUsernameHiddenInput) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (VIEW_TARGET_USERNAME && CURRENT_USER_ROLE === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetUsernameHiddenInput.value = VIEW_TARGET_USERNAME;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetUsernameHiddenInput.value = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  createItemModal.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  createItemNameInput.focus();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (showCreateTextfileModalBtn) showCreateTextfileModalBtn.addEventListener('click', () => openCreateItemModal('textfile'));
Â  Â  Â  Â  Â  Â  if (showCreateFolderModalBtn) showCreateFolderModalBtn.addEventListener('click', () => openCreateItemModal('folder'));
Â  Â  Â  Â  Â  Â  if (closeCreateItemModalBtn) closeCreateItemModalBtn.onclick = () => createItemModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  if (cancelCreateItemBtn) cancelCreateItemBtn.onclick = () => createItemModal.style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // æ–°å¢: è¦–é »æ’­æ”¾å™¨æ¨¡æ…‹æ¡†çš„æ‰“é–‹å’Œé—œé–‰é‚è¼¯
Â  Â  Â  Â  Â  Â  function openVideoPlayer(encodedPath, videoName, videoType) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!videoPlayerModal || !html5VideoPlayer || !videoSourceElement || !videoModalTitle) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let videoSrc = `/stream/${encodedPath}`;
