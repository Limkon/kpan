<%# views/files.ejs %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.pageTitle || ( (locals.viewTargetUsername ? viewTargetUsername : user.username) + ' 的文件') %> - 網路硬碟</title>
    <link rel="stylesheet" href="/style.css">
    <link id="theme-stylesheet" rel="stylesheet" href="">
    <style>
        /* 内联样式可以移到 style.css 中以保持模板清洁 */
        #upload-section {
            display: none; /* 默认隐藏，由JS控制 */
            padding: 20px;
            border: 1px solid #dee2e6; /* 應由主題CSS控制 */
            border-radius: 6px;
            margin-top: 15px;
            background-color: #f8f9fa; /* 應由主題CSS控制 */
        }
        .search-results-info {
            padding: 10px;
            background-color: #e9ecef; /* 應由主題CSS控制 */
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .file-location-in-search {
            font-size: 0.8em;
            color: #6c757d; /* 應由主題CSS控制 */
            margin-left: 8px;
        }
        .file-entry {
            display: flex;
            align-items: center;
            gap: 8px; /* 给图标和文件名之间一些空间 */
        }
        .list-view .file-entry .file-name { /* 确保文件名在列表视图中可以正确显示 */
             overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .grid-view .file-entry { /* 网格视图下，让条目内容垂直居中 */
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <% if (locals.isSearchResult && locals.searchQuery) { %>
                    有關 "<%= searchQuery %>" 的搜尋結果 <% if (locals.viewTargetUsername) { %>(在 <%= viewTargetUsername %> 的文件中)<% } else { %>(在您的文件中)<% } %>
                <% } else if (locals.viewTargetUsername && user.role === 'admin') { %>
                    管理員視角: <%= viewTargetUsername %> 的文件
                <% } else { %>
                    <%= user.username %> 的文件
                <% } %>
            </h1>
            <nav>
                <% if (user.role === 'admin') { %>
                    <a href="/admin">管理面板</a>
                <% } %>
                <a href="/change-password">修改密碼</a>
                <a href="/logout">登出</a>
            </nav>
        </header>

        <% if (locals.message) { %>
            <p class="message <%= (locals.messageType === 'error' || (locals.message && (message.includes('失敗') || message.includes('错误') || message.includes('沒有選擇文件') || message.includes('無效的') ))) ? 'error-message' : (locals.messageType === 'success' ? '' : (locals.messageType === 'warning' ? 'warning-message' : '') ) %>"><%= message %></p>
        <% } %>

        <% if (!locals.isSearchResult) { %>
            <div class="current-path">
                當前路徑:
                <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">根目錄</a>
                <%
                    let pathSegments = currentPath.split('/').filter(Boolean);
                    let cumulativePathForLink = '';
                    const adminTargetQueryForPath = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : '';
                %>
                <% pathSegments.forEach(segment => { %>
                    <% cumulativePathForLink += '/' + segment; %>
                    / <a href="/files?path=<%= encodeURIComponent(cumulativePathForLink) %><%= adminTargetQueryForPath %>"><%= segment %></a>
                <% }); %>
            </div>
        <% } else if (locals.searchQuery) { %>
             <div class="search-results-info">
                正在顯示包含 "<%= searchQuery %>" 的文件。
                <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">清除搜索並返回根目錄</a>
            </div>
        <% } %>

        <div class="file-browser-controls">
            <form action="/files" method="GET" class="control-form" style="flex-grow:2;">
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                <% } %>
                <input type="search" name="q" placeholder="搜索 <%= locals.viewTargetUsername || user.username %> 的文件..." value="<%= locals.searchQuery || '' %>" style="flex-grow:1;">
                <button type="submit">搜索</button>
            </form>

            <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
                <form action="/create-folder" method="POST" class="control-form">
                    <input type="hidden" name="currentPath" value="<%= currentPath %>">
                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                    <% } %>
                    <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                    <input type="text" name="folderName" placeholder="新文件夾名稱" required>
                    <button type="submit">創建文件夾</button>
                </form>
                <button type="button" id="toggleUploadBtn" class="upload-button-main">上傳文件到此</button>
            <% } %>
            <div class="view-toggle">
                <button id="listViewBtn" onclick="toggleView('list')">列表</button>
                <button id="gridViewBtn" onclick="toggleView('grid')">網格</button>
            </div>
        </div>

        <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
            <div id="upload-section">
                <h2>上傳到 "<%= currentPath === '/' ? '根目錄' : currentPath.split('/').pop() %>"</h2>
                <div id="drop-area">
                    <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="currentPath" value="<%= currentPath %>">
                        <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                            <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                        <% } %>
                        <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                        <input type="file" id="userFiles" name="userFiles" multiple style="display: none;">
                        <p>將文件拖拽到此處，或 <label for="userFiles">點擊選擇文件</label></p>
                        <button type="submit" id="upload-button">上傳已選文件</button>
                    </form>
                    <div id="file-list-preview" style="margin-top:10px; text-align:left;"></div>
                </div>
            </div>
        <% } %>

        <h2><%= locals.isSearchResult ? '搜索結果' : '文件列表' %></h2>
        <div id="file-container">
            <% if (items.length > 0) { %>
                <ul>
                    <% items.forEach(item => { %>
                        <li>
                            <% const itemDisplayName = item.name; %>
                            <% const itemPathForLink = item.path; %>
                            <% const encodedItemPathForLink = item.encodedPath; %>
                            <% const adminTargetQueryForActions = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : ''; %>
                            
                            <% if (item.isDir) { %>
                                <div class="file-entry">
                                    <span class="file-icon-large folder-icon">📁</span>
                                    <a href="/files?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="file-name"><%= itemDisplayName %></a>
                                    <% if (locals.isSearchResult) { %>
                                        <span class="file-location-in-search">(位於: <%= (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') %>)</span>
                                    <% } %>
                                </div>
                            <% } else { %>
                                <div class="file-entry">
                                    <%
                                        const ext = itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '';
                                        let largeIcon = '📄'; // 默认图标
                                        if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'log', 'csv', 'py', 'java', 'c', 'cpp', 'go', 'rb'].includes(ext)) { largeIcon = '📝';}
                                        else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) { largeIcon = '🖼️'; }
                                        else if (['pdf'].includes(ext)) { largeIcon = '📕';}
                                        else if (['doc', 'docx', 'odt'].includes(ext)) { largeIcon = '📃';}
                                        else if (['xls', 'xlsx', 'ods'].includes(ext)) { largeIcon = '📊';}
                                        else if (['ppt', 'pptx', 'odp'].includes(ext)) { largeIcon = '🖥️';}
                                        else if (['zip', 'rar', 'tar', 'gz', '7z'].includes(ext)) { largeIcon = '📦';}
                                        else if (['mp3', 'wav', 'ogg', 'aac', 'flac'].includes(ext)) { largeIcon = '🎵';}
                                        else if (['mp4', 'mov', 'avi', 'mkv', 'webm', 'wmv'].includes(ext)) { largeIcon = '🎬';}
                                    %>
                                    <span class="file-icon-large"><%= largeIcon %></span>
                                    <span class="file-name"><%= itemDisplayName %></span>
                                     <% if (locals.isSearchResult) { %>
                                        <span class="file-location-in-search">(位於: <%= (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') %>)</span>
                                    <% } %>
                                </div>
                            <% } %>
                            <span class="file-actions">
                                <a href="#" class="action-link rename-link" onclick="showRenameForm('<%= item.encodedName %>', '<%= itemDisplayName.replace(/'/g, '\\\'').replace(/"/g, '&quot;') %>', <%= item.isDir %>); return false;">重命名</a>
                                <% if (!item.isDir) { %>
                                    <% if (locals.ALLOWED_TEXT_EXTENSIONS && ALLOWED_TEXT_EXTENSIONS.includes(itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '')) { %>
                                        <a href="/edit?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link edit-link">編輯</a>
                                    <% } %>
                                    <a href="/download?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link">下載</a>
                                <% } %>
                                <a href="/delete?path=<%= encodedItemPathForLink %>&isDir=<%= item.isDir %><%= adminTargetQueryForActions %>" class="action-link delete-link" onclick="return confirm('確定要刪除 <%= itemDisplayName.replace(/'/g, '\\\'').replace(/"/g, '&quot;') %><%= item.isDir ? ' 及其所有內容' : '' %> 嗎？');">删除</a>
                            </span>
                            <div class="rename-form" id="rename-form-<%= item.encodedName %>">
                                <form action="/rename" method="POST" class="control-form inline-form">
                                    <input type="hidden" name="currentPath" value="<%= locals.isSearchResult ? (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') : currentPath %>">
                                    <input type="hidden" name="oldPath" value="<%= itemPathForLink %>">
                                    <input type="hidden" name="isDir" value="<%= item.isDir %>">
                                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                                    <% } %>
                                    <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                                    <input type="text" name="newName" placeholder="新名稱" value="<%= itemDisplayName %>" required>
                                    <button type="submit">確認</button>
                                    <button type="button" class="secondary" onclick="hideRenameForm('<%= item.encodedName %>'); return false;">取消</button>
                                </form>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <p><%= locals.isSearchResult ? '找不到符合條件的文件。' : '此文件夾為空。' %></p>
            <% } %>
        </div>
    </div>
    <%- include('partials/theme-switcher') %>
    <script src="/theme.js"></script>
    <script>
        // Script for files.ejs (toggle upload, drag-drop, view toggle, rename form)
        const ALLOWED_TEXT_EXTENSIONS = <%- JSON.stringify(locals.ALLOWED_TEXT_EXTENSIONS || []) %>;

        const toggleUploadBtn = document.getElementById('toggleUploadBtn');
        const uploadSection = document.getElementById('upload-section');
        if (toggleUploadBtn && uploadSection) {
            toggleUploadBtn.addEventListener('click', () => {
                if (uploadSection.style.display === 'none' || uploadSection.style.display === '') {
                    uploadSection.style.display = 'block';
                    toggleUploadBtn.textContent = '隱藏上傳區域';
                } else {
                    uploadSection.style.display = 'none';
                    toggleUploadBtn.textContent = '上傳文件到此';
                }
            });
        }

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('userFiles');
        const fileListPreview = document.getElementById('file-list-preview');
        const uploadButton = document.getElementById('upload-button');

        if (dropArea && fileInput && fileListPreview && uploadButton) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false); // Prevent browser default behavior for whole page
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

            ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false));
            ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false));
            
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                fileInput.files = e.dataTransfer.files;
                updateFileListPreview();
            }
            fileInput.addEventListener('change', updateFileListPreview);

            function updateFileListPreview() {
                fileListPreview.innerHTML = '';
                if (fileInput.files.length > 0) {
                    const list = document.createElement('ul');
                    list.style.listStyleType = 'none'; list.style.paddingLeft = '0';
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const listItem = document.createElement('li');
                        listItem.textContent = fileInput.files[i].name + (fileInput.files[i].size ? ` (${(fileInput.files[i].size / 1024).toFixed(1)} KB)` : '');
                        listItem.style.fontSize = '0.9em';
                        list.appendChild(listItem);
                    }
                    fileListPreview.appendChild(list);
                    uploadButton.style.display = 'inline-block';
                } else {
                    uploadButton.style.display = 'none';
                }
            }
            if(fileInput.files.length === 0) uploadButton.style.display = 'none'; // Initial check
        }

        const fileContainer = document.getElementById('file-container');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        if (fileContainer && listViewBtn && gridViewBtn) {
            function toggleView(viewType) {
                if (viewType === 'grid') {
                    fileContainer.className = 'grid-view';
                    gridViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    localStorage.setItem('fileView', 'grid');
                } else { // Default to list view
                    fileContainer.className = 'list-view';
                    listViewBtn.classList.add('active');
                    gridViewBtn.classList.remove('active');
                    localStorage.setItem('fileView', 'list');
                }
            }
            const preferredView = localStorage.getItem('fileView');
            toggleView(preferredView || 'list'); // Default to list if no preference

            listViewBtn.addEventListener('click', () => toggleView('list'));
            gridViewBtn.addEventListener('click', () => toggleView('grid'));
        }

        function showRenameForm(encodedName, currentName, isDir) {
            document.querySelectorAll('.rename-form').forEach(form => form.style.display = 'none'); // Hide all first
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) {
                form.style.display = 'block';
                const inputField = form.querySelector('input[name="newName"]');
                if (inputField) {
                    inputField.value = currentName; // Set current name
                    inputField.focus();
                    inputField.select();
                }
            }
        }
        function hideRenameForm(encodedName) {
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) form.style.display = 'none';
        }
    </script>
</body>
</html>
