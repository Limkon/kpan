<%# views/files.ejs %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.pageTitle || ( (locals.viewTargetUsername ? viewTargetUsername : user.username) + ' çš„æ–‡ä»¶') %> - ç¶²è·¯ç¡¬ç¢Ÿ</title>
    <link rel="stylesheet" href="/style.css">
    <link id="theme-stylesheet" rel="stylesheet" href="">
    <style>
        /* å†…è”æ ·å¼å¯ä»¥ç§»åˆ° style.css ä¸­ä»¥ä¿æŒæ¨¡æ¿æ¸…æ´ */
        #upload-section {
            display: none; /* é»˜è®¤éšè—ï¼Œç”±JSæ§åˆ¶ */
            padding: 20px;
            border: 1px solid #dee2e6; /* æ‡‰ç”±ä¸»é¡ŒCSSæ§åˆ¶ */
            border-radius: 6px;
            margin-top: 15px;
            background-color: #f8f9fa; /* æ‡‰ç”±ä¸»é¡ŒCSSæ§åˆ¶ */
        }
        .search-results-info {
            padding: 10px;
            background-color: #e9ecef; /* æ‡‰ç”±ä¸»é¡ŒCSSæ§åˆ¶ */
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .file-location-in-search {
            font-size: 0.8em;
            color: #6c757d; /* æ‡‰ç”±ä¸»é¡ŒCSSæ§åˆ¶ */
            margin-left: 8px;
        }
        .file-entry {
            display: flex;
            align-items: center;
            gap: 8px; /* ç»™å›¾æ ‡å’Œæ–‡ä»¶åä¹‹é—´ä¸€äº›ç©ºé—´ */
        }
        .list-view .file-entry .file-name { /* ç¡®ä¿æ–‡ä»¶ååœ¨åˆ—è¡¨è§†å›¾ä¸­å¯ä»¥æ­£ç¡®æ˜¾ç¤º */
             overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .grid-view .file-entry { /* ç½‘æ ¼è§†å›¾ä¸‹ï¼Œè®©æ¡ç›®å†…å®¹å‚ç›´å±…ä¸­ */
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <% if (locals.isSearchResult && locals.searchQuery) { %>
                    æœ‰é—œ "<%= searchQuery %>" çš„æœå°‹çµæœ <% if (locals.viewTargetUsername) { %>(åœ¨ <%= viewTargetUsername %> çš„æ–‡ä»¶ä¸­)<% } else { %>(åœ¨æ‚¨çš„æ–‡ä»¶ä¸­)<% } %>
                <% } else if (locals.viewTargetUsername && user.role === 'admin') { %>
                    ç®¡ç†å“¡è¦–è§’: <%= viewTargetUsername %> çš„æ–‡ä»¶
                <% } else { %>
                    <%= user.username %> çš„æ–‡ä»¶
                <% } %>
            </h1>
            <nav>
                <% if (user.role === 'admin') { %>
                    <a href="/admin">ç®¡ç†é¢æ¿</a>
                <% } %>
                <a href="/change-password">ä¿®æ”¹å¯†ç¢¼</a>
                <a href="/logout">ç™»å‡º</a>
            </nav>
        </header>

        <% if (locals.message) { %>
            <p class="message <%= (locals.messageType === 'error' || (locals.message && (message.includes('å¤±æ•—') || message.includes('é”™è¯¯') || message.includes('æ²’æœ‰é¸æ“‡æ–‡ä»¶') || message.includes('ç„¡æ•ˆçš„') ))) ? 'error-message' : (locals.messageType === 'success' ? '' : (locals.messageType === 'warning' ? 'warning-message' : '') ) %>"><%= message %></p>
        <% } %>

        <% if (!locals.isSearchResult) { %>
            <div class="current-path">
                ç•¶å‰è·¯å¾‘:
                <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">æ ¹ç›®éŒ„</a>
                <%
                    let pathSegments = currentPath.split('/').filter(Boolean);
                    let cumulativePathForLink = '';
                    const adminTargetQueryForPath = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : '';
                %>
                <% pathSegments.forEach(segment => { %>
                    <% cumulativePathForLink += '/' + segment; %>
                    / <a href="/files?path=<%= encodeURIComponent(cumulativePathForLink) %><%= adminTargetQueryForPath %>"><%= segment %></a>
                <% }); %>
            </div>
        <% } else if (locals.searchQuery) { %>
             <div class="search-results-info">
                æ­£åœ¨é¡¯ç¤ºåŒ…å« "<%= searchQuery %>" çš„æ–‡ä»¶ã€‚
                <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">æ¸…é™¤æœç´¢ä¸¦è¿”å›æ ¹ç›®éŒ„</a>
            </div>
        <% } %>

        <div class="file-browser-controls">
            <form action="/files" method="GET" class="control-form" style="flex-grow:2;">
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                <% } %>
                <input type="search" name="q" placeholder="æœç´¢ <%= locals.viewTargetUsername || user.username %> çš„æ–‡ä»¶..." value="<%= locals.searchQuery || '' %>" style="flex-grow:1;">
                <button type="submit">æœç´¢</button>
            </form>

            <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
                <form action="/create-folder" method="POST" class="control-form">
                    <input type="hidden" name="currentPath" value="<%= currentPath %>">
                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                    <% } %>
                    <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                    <input type="text" name="folderName" placeholder="æ–°æ–‡ä»¶å¤¾åç¨±" required>
                    <button type="submit">å‰µå»ºæ–‡ä»¶å¤¾</button>
                </form>
                <button type="button" id="toggleUploadBtn" class="upload-button-main">ä¸Šå‚³æ–‡ä»¶åˆ°æ­¤</button>
            <% } %>
            <div class="view-toggle">
                <button id="listViewBtn" onclick="toggleView('list')">åˆ—è¡¨</button>
                <button id="gridViewBtn" onclick="toggleView('grid')">ç¶²æ ¼</button>
            </div>
        </div>

        <% if (!locals.isSearchResult && currentPath && currentPath !== '/search-results') { %>
            <div id="upload-section">
                <h2>ä¸Šå‚³åˆ° "<%= currentPath === '/' ? 'æ ¹ç›®éŒ„' : currentPath.split('/').pop() %>"</h2>
                <div id="drop-area">
                    <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="currentPath" value="<%= currentPath %>">
                        <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                            <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                        <% } %>
                        <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                        <input type="file" id="userFiles" name="userFiles" multiple style="display: none;">
                        <p>å°‡æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤è™•ï¼Œæˆ– <label for="userFiles">é»æ“Šé¸æ“‡æ–‡ä»¶</label></p>
                        <button type="submit" id="upload-button">ä¸Šå‚³å·²é¸æ–‡ä»¶</button>
                    </form>
                    <div id="file-list-preview" style="margin-top:10px; text-align:left;"></div>
                </div>
            </div>
        <% } %>

        <h2><%= locals.isSearchResult ? 'æœç´¢çµæœ' : 'æ–‡ä»¶åˆ—è¡¨' %></h2>
        <div id="file-container">
            <% if (items.length > 0) { %>
                <ul>
                    <% items.forEach(item => { %>
                        <li>
                            <% const itemDisplayName = item.name; %>
                            <% const itemPathForLink = item.path; %>
                            <% const encodedItemPathForLink = item.encodedPath; %>
                            <% const adminTargetQueryForActions = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : ''; %>
                            
                            <% if (item.isDir) { %>
                                <div class="file-entry">
                                    <span class="file-icon-large folder-icon">ğŸ“</span>
                                    <a href="/files?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="file-name"><%= itemDisplayName %></a>
                                    <% if (locals.isSearchResult) { %>
                                        <span class="file-location-in-search">(ä½æ–¼: <%= (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') %>)</span>
                                    <% } %>
                                </div>
                            <% } else { %>
                                <div class="file-entry">
                                    <%
                                        const ext = itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '';
                                        let largeIcon = 'ğŸ“„'; // é»˜è®¤å›¾æ ‡
                                        if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'log', 'csv', 'py', 'java', 'c', 'cpp', 'go', 'rb'].includes(ext)) { largeIcon = 'ğŸ“';}
                                        else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) { largeIcon = 'ğŸ–¼ï¸'; }
                                        else if (['pdf'].includes(ext)) { largeIcon = 'ğŸ“•';}
                                        else if (['doc', 'docx', 'odt'].includes(ext)) { largeIcon = 'ğŸ“ƒ';}
                                        else if (['xls', 'xlsx', 'ods'].includes(ext)) { largeIcon = 'ğŸ“Š';}
                                        else if (['ppt', 'pptx', 'odp'].includes(ext)) { largeIcon = 'ğŸ–¥ï¸';}
                                        else if (['zip', 'rar', 'tar', 'gz', '7z'].includes(ext)) { largeIcon = 'ğŸ“¦';}
                                        else if (['mp3', 'wav', 'ogg', 'aac', 'flac'].includes(ext)) { largeIcon = 'ğŸµ';}
                                        else if (['mp4', 'mov', 'avi', 'mkv', 'webm', 'wmv'].includes(ext)) { largeIcon = 'ğŸ¬';}
                                    %>
                                    <span class="file-icon-large"><%= largeIcon %></span>
                                    <span class="file-name"><%= itemDisplayName %></span>
                                     <% if (locals.isSearchResult) { %>
                                        <span class="file-location-in-search">(ä½æ–¼: <%= (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') %>)</span>
                                    <% } %>
                                </div>
                            <% } %>
                            <span class="file-actions">
                                <a href="#" class="action-link rename-link" onclick="showRenameForm('<%= item.encodedName %>', '<%= itemDisplayName.replace(/'/g, '\\\'').replace(/"/g, '&quot;') %>', <%= item.isDir %>); return false;">é‡å‘½å</a>
                                <% if (!item.isDir) { %>
                                    <% if (locals.ALLOWED_TEXT_EXTENSIONS && ALLOWED_TEXT_EXTENSIONS.includes(itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '')) { %>
                                        <a href="/edit?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link edit-link">ç·¨è¼¯</a>
                                    <% } %>
                                    <a href="/download?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link">ä¸‹è¼‰</a>
                                <% } %>
                                <a href="/delete?path=<%= encodedItemPathForLink %>&isDir=<%= item.isDir %><%= adminTargetQueryForActions %>" class="action-link delete-link" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤ <%= itemDisplayName.replace(/'/g, '\\\'').replace(/"/g, '&quot;') %><%= item.isDir ? ' åŠå…¶æ‰€æœ‰å…§å®¹' : '' %> å—ï¼Ÿ');">åˆ é™¤</a>
                            </span>
                            <div class="rename-form" id="rename-form-<%= item.encodedName %>">
                                <form action="/rename" method="POST" class="control-form inline-form">
                                    <input type="hidden" name="currentPath" value="<%= locals.isSearchResult ? (itemPathForLink.substring(0, itemPathForLink.lastIndexOf('/')) || '/') : currentPath %>">
                                    <input type="hidden" name="oldPath" value="<%= itemPathForLink %>">
                                    <input type="hidden" name="isDir" value="<%= item.isDir %>">
                                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                                    <% } %>
                                    <% if (locals.csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
                                    <input type="text" name="newName" placeholder="æ–°åç¨±" value="<%= itemDisplayName %>" required>
                                    <button type="submit">ç¢ºèª</button>
                                    <button type="button" class="secondary" onclick="hideRenameForm('<%= item.encodedName %>'); return false;">å–æ¶ˆ</button>
                                </form>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <p><%= locals.isSearchResult ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ–‡ä»¶ã€‚' : 'æ­¤æ–‡ä»¶å¤¾ç‚ºç©ºã€‚' %></p>
            <% } %>
        </div>
    </div>
    <%- include('partials/theme-switcher') %>
    <script src="/theme.js"></script>
    <script>
        // Script for files.ejs (toggle upload, drag-drop, view toggle, rename form)
        const ALLOWED_TEXT_EXTENSIONS = <%- JSON.stringify(locals.ALLOWED_TEXT_EXTENSIONS || []) %>;

        const toggleUploadBtn = document.getElementById('toggleUploadBtn');
        const uploadSection = document.getElementById('upload-section');
        if (toggleUploadBtn && uploadSection) {
            toggleUploadBtn.addEventListener('click', () => {
                if (uploadSection.style.display === 'none' || uploadSection.style.display === '') {
                    uploadSection.style.display = 'block';
                    toggleUploadBtn.textContent = 'éš±è—ä¸Šå‚³å€åŸŸ';
                } else {
                    uploadSection.style.display = 'none';
                    toggleUploadBtn.textContent = 'ä¸Šå‚³æ–‡ä»¶åˆ°æ­¤';
                }
            });
        }

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('userFiles');
        const fileListPreview = document.getElementById('file-list-preview');
        const uploadButton = document.getElementById('upload-button');

        if (dropArea && fileInput && fileListPreview && uploadButton) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false); // Prevent browser default behavior for whole page
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

            ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false));
            ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false));
            
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                fileInput.files = e.dataTransfer.files;
                updateFileListPreview();
            }
            fileInput.addEventListener('change', updateFileListPreview);

            function updateFileListPreview() {
                fileListPreview.innerHTML = '';
                if (fileInput.files.length > 0) {
                    const list = document.createElement('ul');
                    list.style.listStyleType = 'none'; list.style.paddingLeft = '0';
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const listItem = document.createElement('li');
                        listItem.textContent = fileInput.files[i].name + (fileInput.files[i].size ? ` (${(fileInput.files[i].size / 1024).toFixed(1)} KB)` : '');
                        listItem.style.fontSize = '0.9em';
                        list.appendChild(listItem);
                    }
                    fileListPreview.appendChild(list);
                    uploadButton.style.display = 'inline-block';
                } else {
                    uploadButton.style.display = 'none';
                }
            }
            if(fileInput.files.length === 0) uploadButton.style.display = 'none'; // Initial check
        }

        const fileContainer = document.getElementById('file-container');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        if (fileContainer && listViewBtn && gridViewBtn) {
            function toggleView(viewType) {
                if (viewType === 'grid') {
                    fileContainer.className = 'grid-view';
                    gridViewBtn.classList.add('active');
                    listViewBtn.classList.remove('active');
                    localStorage.setItem('fileView', 'grid');
                } else { // Default to list view
                    fileContainer.className = 'list-view';
                    listViewBtn.classList.add('active');
                    gridViewBtn.classList.remove('active');
                    localStorage.setItem('fileView', 'list');
                }
            }
            const preferredView = localStorage.getItem('fileView');
            toggleView(preferredView || 'list'); // Default to list if no preference

            listViewBtn.addEventListener('click', () => toggleView('list'));
            gridViewBtn.addEventListener('click', () => toggleView('grid'));
        }

        function showRenameForm(encodedName, currentName, isDir) {
            document.querySelectorAll('.rename-form').forEach(form => form.style.display = 'none'); // Hide all first
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) {
                form.style.display = 'block';
                const inputField = form.querySelector('input[name="newName"]');
                if (inputField) {
                    inputField.value = currentName; // Set current name
                    inputField.focus();
                    inputField.select();
                }
            }
        }
        function hideRenameForm(encodedName) {
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) form.style.display = 'none';
        }
    </script>
</body>
</html>
