<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.viewTargetUsername ? viewTargetUsername + ' ÁöÑÊñá‰ª∂' : user.username + ' ÁöÑÊñá‰ª∂' %> - Á∂≤Ë∑ØÁ°¨Á¢ü</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    ÁÆ°ÁêÜÂì°Ë¶ñËßí: <%= viewTargetUsername %> ÁöÑÊñá‰ª∂
                <% } else { %>
                    <%= user.username %> ÁöÑÊñá‰ª∂
                <% } %>
            </h1>
            <nav>
                <% if (user.role === 'admin') { %>
                    <a href="/admin">ÁÆ°ÁêÜÈù¢Êùø</a>
                <% } %>
                <a href="/change-password">‰øÆÊîπÂØÜÁ¢º</a>
                <a href="/logout">ÁôªÂá∫</a>
            </nav>
        </header>

        <% if (locals.message) { %>
            <p class="message <%= (locals.messageType === 'error' || (locals.message && (message.includes('Â§±Êïó') || message.includes('ÈîôËØØ') || message.includes('Ê≤íÊúâÈÅ∏ÊìáÊñá‰ª∂')))) ? 'error-message' : '' %>"><%= message %></p>
        <% } %>

        <div class="current-path">
            Áï∂ÂâçË∑ØÂæë:
            <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">Ê†πÁõÆÈåÑ</a>
            <%
                let pathSegments = currentPath.split('/').filter(Boolean);
                let cumulativePathForLink = '';
                const adminTargetQuery = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : '';
            %>
            <% pathSegments.forEach(segment => { %>
                <% cumulativePathForLink += '/' + segment; %>
                / <a href="/files?path=<%= encodeURIComponent(cumulativePathForLink) %><%= adminTargetQuery %>"><%= segment %></a>
            <% }); %>
        </div>

        <div class="file-browser-controls">
            <form action="/create-folder" method="POST" class="control-form">
                <input type="hidden" name="currentPath" value="<%= currentPath %>">
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                <% } %>
                <input type="text" name="folderName" placeholder="Êñ∞Êñá‰ª∂Â§æÂêçÁ®±" required>
                <button type="submit">ÂâµÂª∫Êñá‰ª∂Â§æ</button>
            </form>
            <%
                let uploadPageLink = `/upload-page?currentPath=${encodeURIComponent(currentPath)}`;
                if (locals.viewTargetUsername && user.role === 'admin') {
                    uploadPageLink += `&targetUsername=${encodeURIComponent(viewTargetUsername)}`;
                }
            %>
            <a href="<%= uploadPageLink %>" class="button-link upload-button-main">‰∏äÂÇ≥Êñá‰ª∂</a>
            <div class="view-toggle">
                <button id="listViewBtn" onclick="toggleView('list')">ÂàóË°®</button>
                <button id="gridViewBtn" onclick="toggleView('grid')">Á∂≤Ê†º</button>
            </div>
        </div>

        <h2>Êñá‰ª∂ÂàóË°®</h2>
        <div id="file-container"> <% if (items.length > 0) { %>
                <ul>
                    <% items.forEach(item => { %>
                        <li>
                            <% const itemDisplayName = item.name; %>
                            <% const itemPathForLink = item.path; %>
                            <% const encodedItemPathForLink = item.encodedPath; %>
                            <% const adminTargetQueryForActions = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : ''; %>

                            <% if (item.isDir) { %>
                                <div class="file-entry">
                                    <span class="file-icon-large folder-icon">üìÅ</span>
                                    <a href="/files?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="file-name"><%= itemDisplayName %></a>
                                </div>
                            <% } else { %>
                                <div class="file-entry">
                                     <%
                                        const ext = itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '';
                                        let largeIcon = 'üìÑ';
                                        if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'log', 'csv', 'py', 'java', 'c', 'cpp', 'go', 'rb'].includes(ext)) { largeIcon = 'üìù';}
                                        else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) { largeIcon = 'üñºÔ∏è'; }
                                        else if (['pdf'].includes(ext)) { largeIcon = 'üìï';}
                                        else if (['doc', 'docx'].includes(ext)) { largeIcon = 'üìÉ';}
                                        else if (['xls', 'xlsx'].includes(ext)) { largeIcon = 'üìä';}
                                        else if (['ppt', 'pptx'].includes(ext)) { largeIcon = 'üñ•Ô∏è';}
                                        else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) { largeIcon = 'üì¶';}
                                        else if (['mp3', 'wav', 'ogg', 'aac'].includes(ext)) { largeIcon = 'üéµ';}
                                        else if (['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext)) { largeIcon = 'üé¨';}
                                    %>
                                    <span class="file-icon-large"><%= largeIcon %></span>
                                    <span class="file-name"><%= itemDisplayName %></span>
                                </div>
                            <% } %>
                            <span class="file-actions">
                                <a href="#" class="action-link rename-link" onclick="showRenameForm('<%= item.encodedName %>', '<%= itemDisplayName.replace(/'/g, '\\\'') %>', <%= item.isDir %>); return false;">ÈáçÂëΩÂêç</a>
                                <% if (!item.isDir) { %>
                                    <% if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'log', 'csv', 'py', 'java', 'c', 'cpp', 'go', 'rb'].includes(itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '')) { %>
                                        <a href="/edit?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link edit-link">Á∑®ËºØ</a>
                                    <% } %>
                                    <a href="/download?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="action-link">‰∏ãËºâ</a>
                                <% } %>
                                <a href="/delete?path=<%= encodedItemPathForLink %>&isDir=<%= item.isDir %><%= adminTargetQueryForActions %>" class="action-link delete-link" onclick="return confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ <%= itemDisplayName.replace(/'/g, '\\\'') %><%= item.isDir ? ' ÂèäÂÖ∂ÊâÄÊúâÂÖßÂÆπ' : '' %> ÂóéÔºü');">Âà†Èô§</a>
                            </span>
                            <div class="rename-form" id="rename-form-<%= item.encodedName %>">
                                <form action="/rename" method="POST" class="control-form inline-form">
                                    <input type="hidden" name="currentPath" value="<%= currentPath %>">
                                    <input type="hidden" name="oldPath" value="<%= itemPathForLink %>">
                                    <input type="hidden" name="isDir" value="<%= item.isDir %>">
                                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                                    <% } %>
                                    <input type="text" name="newName" placeholder="Êñ∞ÂêçÁ®±" value="<%= itemDisplayName %>" required>
                                    <button type="submit">Á¢∫Ë™ç</button>
                                    <button type="button" class="secondary" onclick="hideRenameForm('<%= item.encodedName %>'); return false;">ÂèñÊ∂à</button>
                                </form>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <p>Ê≠§Êñá‰ª∂Â§æÁÇ∫Á©∫„ÄÇ</p>
            <% } %>
        </div>
    </div>

    <script>
        // View Toggle (same as before)
        const fileContainer = document.getElementById('file-container');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');

        function toggleView(viewType) {
            if (viewType === 'grid') {
                fileContainer.className = 'grid-view';
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                localStorage.setItem('fileView', 'grid');
            } else {
                fileContainer.className = 'list-view';
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
                localStorage.setItem('fileView', 'list');
            }
        }
        const preferredView = localStorage.getItem('fileView');
        toggleView(preferredView || 'list');

        // Rename Form (same as before)
        function showRenameForm(encodedName, currentName, isDir) {
            document.querySelectorAll('.rename-form').forEach(form => form.style.display = 'none');
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) {
                form.style.display = 'block';
                form.querySelector('input[name="newName"]').focus();
                form.querySelector('input[name="newName"]').select();
            }
        }
        function hideRenameForm(encodedName) {
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) form.style.display = 'none';
        }
    </script>
</body>
</html>
