<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= locals.viewTargetUsername ? viewTargetUsername + ' 的文件' : user.username + ' 的文件' %> - 網路硬碟</title>
    <link rel="stylesheet" href="/style.css">
    <link id="theme-stylesheet" rel="stylesheet" href="">
    <style>
        #upload-section {
            display: none;
            padding: 20px;
            border: 1px solid #dee2e6; /* Will be themed */
            border-radius: 6px;
            margin-top: 15px;
            background-color: #f8f9fa; /* Will be themed */
        }
        .global-actions-bar {
            padding: 10px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee; /* Will be themed */
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .global-actions-bar button, .global-actions-bar .button-link {
            margin-bottom: 5px;
        }
        .file-item-checkbox {
            margin-right: 10px;
            vertical-align: middle;
        }
        #move-destination-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-background, #fff);
            padding: 20px;
            border: 1px solid var(--border-color, #ccc);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
        }
        #move-destination-popup label { margin-bottom: 8px; display: block; }
        #move-destination-popup input[type="text"] { width: 100%; margin-bottom: 10px; box-sizing: border-box;}
        #move-destination-popup .popup-actions button { margin-right: 10px;}
        #move-destination-popup .popup-actions { margin-top:15px; text-align: right; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    管理員視角: <%= viewTargetUsername %> 的文件
                <% } else { %>
                    <%= user.username %> 的文件
                <% } %>
            </h1>
            <nav>
                <% if (user.role === 'admin') { %>
                    <a href="/admin">管理面板</a>
                <% } %>
                <a href="/change-password">修改密碼</a>
                <a href="/logout">登出</a>
            </nav>
        </header>

        <% if (locals.message) { %>
            <p class="message <%= (locals.messageType === 'error') ? 'error-message' : '' %>"><%= message %></p>
        <% } %>

        <div class="current-path">
            當前路徑:
            <a href="/files<%= locals.viewTargetUsername && user.role === 'admin' ? '?targetUsername=' + encodeURIComponent(viewTargetUsername) : '' %>">根目錄</a>
            <%
                let pathSegments = currentPath.split('/').filter(Boolean);
                let cumulativePathForLink = '';
                const adminTargetQuery = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : '';
            %>
            <% pathSegments.forEach(segment => { %>
                <% cumulativePathForLink += '/' + segment; %>
                / <a href="/files?path=<%= encodeURIComponent(cumulativePathForLink) %><%= adminTargetQuery %>"><%= segment %></a>
            <% }); %>
        </div>

        <div class="file-browser-controls">
            <form action="/create-folder" method="POST" class="control-form">
                <input type="hidden" name="currentPath" value="<%= currentPath %>">
                <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                    <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                <% } %>
                <input type="text" name="folderName" placeholder="新文件夾名稱" required>
                <button type="submit">創建文件夾</button>
            </form>
            <button type="button" id="toggleUploadBtnGlobal" class="upload-button-main">上傳文件</button>
            <div class="view-toggle">
                <button id="listViewBtn" onclick="toggleView('list')">列表</button>
                <button id="gridViewBtn" onclick="toggleView('grid')">網格</button>
            </div>
        </div>

        <div class="global-actions-bar">
            <label for="selectAllCheckbox">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"> 全選
            </label>
            <button id="globalRenameBtn" disabled onclick="handleGlobalRename()">重命名</button>
            <button id="globalDownloadBtn" disabled onclick="handleGlobalDownload()">下載選中</button>
            <button id="globalDeleteBtn" disabled onclick="handleGlobalDelete()">刪除選中</button>
            <button id="globalMoveBtn" disabled onclick="showMovePopup()">移動選中到...</button>
        </div>

        <div id="upload-section">
            <h2>上傳到 "<%= currentPath === '/' ? '根目錄' : currentPath.split('/').pop() %>"</h2>
            <div id="drop-area">
                <form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="currentPath" value="<%= currentPath %>">
                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                    <% } %>
                    <input type="file" id="userFiles" name="userFiles" multiple style="display: none;">
                    <p>將文件拖拽到此處，或 <label for="userFiles">點擊選擇文件</label></p>
                    <button type="submit" id="upload-button">上傳已選文件</button>
                </form>
                <div id="file-list-preview" style="margin-top:10px; text-align:left;"></div>
            </div>
        </div>

        <h2>文件列表</h2>
        <div id="file-container">
            <% if (items.length > 0) { %>
                <ul>
                    <% items.forEach(item => { %>
                        <li>
                            <input type="checkbox" class="file-item-checkbox" value="<%= item.path %>" data-name="<%= item.name %>" data-isdir="<%= item.isDir %>" data-encodedname="<%= item.encodedName %>" onchange="updateGlobalActionButtons()">
                            <% const itemDisplayName = item.name; %>
                            <% const itemPathForLink = item.path; %>
                            <% const encodedItemPathForLink = item.encodedPath; %>
                            <% const adminTargetQueryForActions = locals.viewTargetUsername && user.role === 'admin' ? '&targetUsername=' + encodeURIComponent(viewTargetUsername) : ''; %>

                            <% if (item.isDir) { %>
                                <div class="file-entry">
                                    <span class="file-icon-large folder-icon">📁</span>
                                    <a href="/files?path=<%= encodedItemPathForLink %><%= adminTargetQueryForActions %>" class="file-name"><%= itemDisplayName %></a>
                                </div>
                            <% } else { %>
                                <div class="file-entry">
                                     <%
                                        const ext = itemDisplayName.includes('.') ? itemDisplayName.substring(itemDisplayName.lastIndexOf('.') + 1).toLowerCase() : '';
                                        let largeIcon = '📄';
                                        if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'log', 'csv', 'py', 'java', 'c', 'cpp', 'go', 'rb'].includes(ext)) { largeIcon = '📝';}
                                        else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext)) { largeIcon = '🖼️'; }
                                        else if (['pdf'].includes(ext)) { largeIcon = '📕';}
                                        else if (['doc', 'docx'].includes(ext)) { largeIcon = '📃';}
                                        else if (['xls', 'xlsx'].includes(ext)) { largeIcon = '📊';}
                                        else if (['ppt', 'pptx'].includes(ext)) { largeIcon = '🖥️';}
                                        else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) { largeIcon = '📦';}
                                        else if (['mp3', 'wav', 'ogg', 'aac'].includes(ext)) { largeIcon = '🎵';}
                                        else if (['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext)) { largeIcon = '🎬';}
                                    %>
                                    <span class="file-icon-large"><%= largeIcon %></span>
                                    <span class="file-name"><%= itemDisplayName %></span>
                                </div>
                            <% } %>
                            <span class="file-actions" style="display:none;">
                                <a href="#" class="action-link rename-link" onclick="showRenameForm('<%= item.encodedName %>', '<%= itemDisplayName.replace(/'/g, '\\\'') %>', <%= item.isDir %>); return false;">重命名(隱藏)</a>
                            </span>
                            <div class="rename-form" id="rename-form-<%= item.encodedName %>">
                                <form action="/rename" method="POST" class="control-form inline-form">
                                    <input type="hidden" name="currentPath" value="<%= currentPath %>">
                                    <input type="hidden" name="oldPath" value="<%= itemPathForLink %>">
                                    <input type="hidden" name="isDir" value="<%= item.isDir %>">
                                    <% if (locals.viewTargetUsername && user.role === 'admin') { %>
                                        <input type="hidden" name="targetUsername" value="<%= viewTargetUsername %>">
                                    <% } %>
                                    <input type="text" name="newName" placeholder="新名稱" value="<%= itemDisplayName %>" required>
                                    <button type="submit">確認</button>
                                    <button type="button" class="secondary" onclick="hideRenameForm('<%= item.encodedName %>'); return false;">取消</button>
                                </form>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <p>此文件夾為空。</p>
            <% } %>
        </div>
    </div>

    <div id="move-destination-popup">
        <h3>移動選中項目到:</h3>
        <form id="move-form" onsubmit="handleActualMove(event)">
            <div>
                <label for="destinationPath">目標路徑 (例如 /我的文件夾/子文件夾):</label>
                <input type="text" id="destinationPath" name="destinationPath" value="/" required>
            </div>
            <div class="popup-actions">
                <button type="submit">確認移動</button>
                <button type="button" class="secondary" onclick="hideMovePopup()">取消</button>
            </div>
        </form>
    </div>

    <%- include('partials/theme-switcher') %>
    <script src="/theme.js"></script>
    <script>
        // Toggle Upload Section
        const toggleUploadBtn = document.getElementById('toggleUploadBtnGlobal');
        const uploadSection = document.getElementById('upload-section');
        if (toggleUploadBtn && uploadSection) {
            toggleUploadBtn.addEventListener('click', () => {
                const isHidden = uploadSection.style.display === 'none' || uploadSection.style.display === '';
                uploadSection.style.display = isHidden ? 'block' : 'none';
                toggleUploadBtn.textContent = isHidden ? '隱藏上傳區域' : '上傳文件';
            });
        }

        // Drag and Drop
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('userFiles');
        const fileListPreview = document.getElementById('file-list-preview');
        const uploadButton = document.getElementById('upload-button');
        if (dropArea && fileInput && fileListPreview && uploadButton) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false));
            ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false));
            dropArea.addEventListener('drop', handleDrop, false);
            function handleDrop(e) {
                fileInput.files = e.dataTransfer.files;
                updateFileListPreview();
            }
            fileInput.addEventListener('change', updateFileListPreview);
            function updateFileListPreview() {
                fileListPreview.innerHTML = '';
                if (fileInput.files.length > 0) {
                    const list = document.createElement('ul');
                    list.style.listStyleType = 'none'; list.style.paddingLeft = '0';
                    for (let i = 0; i < fileInput.files.length; i++) {
                        const listItem = document.createElement('li');
                        listItem.textContent = fileInput.files[i].name + ' (' + (files[i].size / 1024).toFixed(2) + ' KB)';
                        listItem.style.fontSize = '0.9em'; listItem.style.color = '#333';
                        list.appendChild(listItem);
                    }
                    fileListPreview.appendChild(list);
                    uploadButton.style.display = 'inline-block';
                } else {
                    uploadButton.style.display = 'none';
                }
            }
            if(fileInput.files.length === 0) uploadButton.style.display = 'none';
        }

        // View Toggle
        const fileContainer = document.getElementById('file-container');
        const listViewBtn = document.getElementById('listViewBtn');
        const gridViewBtn = document.getElementById('gridViewBtn');
        if (fileContainer && listViewBtn && gridViewBtn) {
            function toggleView(viewType) {
                fileContainer.className = viewType === 'grid' ? 'grid-view' : 'list-view';
                gridViewBtn.classList.toggle('active', viewType === 'grid');
                listViewBtn.classList.toggle('active', viewType === 'list');
                localStorage.setItem('fileView', viewType);
            }
            toggleView(localStorage.getItem('fileView') || 'list');
        }

        // Rename Form
        function showRenameForm(encodedName, currentName, isDir) {
            document.querySelectorAll('.rename-form').forEach(form => form.style.display = 'none');
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) {
                form.style.display = 'block';
                const input = form.querySelector('input[name="newName"]');
                input.value = currentName; // Pre-fill with current name
                input.focus();
                input.select();
            }
        }
        function hideRenameForm(encodedName) {
            const form = document.getElementById('rename-form-' + encodedName);
            if (form) form.style.display = 'none';
        }

        // Global Actions Logic
        const globalRenameBtn = document.getElementById('globalRenameBtn');
        const globalDownloadBtn = document.getElementById('globalDownloadBtn');
        const globalDeleteBtn = document.getElementById('globalDeleteBtn');
        const globalMoveBtn = document.getElementById('globalMoveBtn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const itemCheckboxes = document.querySelectorAll('.file-item-checkbox');

        function getSelectedItems() {
            return Array.from(itemCheckboxes)
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => ({
                            path: checkbox.value,
                            name: checkbox.dataset.name,
                            isDir: checkbox.dataset.isdir === 'true',
                            encodedName: checkbox.dataset.encodedname
                        }));
        }

        function updateGlobalActionButtons() {
            const selectedItems = getSelectedItems();
            const count = selectedItems.length;
            globalDownloadBtn.disabled = count === 0;
            globalDeleteBtn.disabled = count === 0;
            globalMoveBtn.disabled = count === 0;
            globalRenameBtn.disabled = count !== 1;
            if (selectAllCheckbox) {
                 selectAllCheckbox.checked = count > 0 && count === itemCheckboxes.length;
                 selectAllCheckbox.indeterminate = count > 0 && count < itemCheckboxes.length;
            }
        }

        function toggleSelectAll(checked) {
            itemCheckboxes.forEach(checkbox => checkbox.checked = checked);
            updateGlobalActionButtons();
        }

        function handleGlobalRename() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 1) {
                showRenameForm(selectedItems[0].encodedName, selectedItems[0].name, selectedItems[0].isDir);
            }
        }

        // --- Batch Operations Fetch Logic ---
        async function performBatchOperation(url, items, additionalData = {}) {
            const actingUser = "<%= user.username %>"; // Current logged-in user
            const currentPathVal = "<%= currentPath %>";
            const targetUsernameVal = <%= locals.viewTargetUsername && user.role === 'admin' ? JSON.stringify(viewTargetUsername) : null %>;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: items,
                        targetUsername: targetUsernameVal,
                        currentPath: currentPathVal, // For redirecting back to the correct folder
                        ...additionalData
                    })
                });
                // For delete and move, backend redirects, so we check for redirect or handle JSON
                if (response.redirected) {
                    window.location.href = response.url; // Follow redirect which should include messages
                } else if (response.ok && url === '/batch-download') { // Special handling for download
                     // The browser should handle the download via res.attachment() in backend
                     // If not, this might need a form submission trick as discussed
                     // For now, assume backend handles direct download response
                     // We might need to create a temporary form and submit it for download
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/batch-download';

                    items.forEach(item => { // Assuming 'items' here are just paths for download
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'paths[]';
                        input.value = item.path; // Or just item if items are paths directly
                        form.appendChild(input);
                    });
                    if (targetUsernameVal) {
                        const inputTarget = document.createElement('input');
                        inputTarget.type = 'hidden'; inputTarget.name = 'targetUsername'; inputTarget.value = targetUsernameVal;
                        form.appendChild(inputTarget);
                    }
                    const inputCurrentPath = document.createElement('input');
                    inputCurrentPath.type = 'hidden'; inputCurrentPath.name = 'currentPath'; inputCurrentPath.value = currentPathVal;
                    form.appendChild(inputCurrentPath);

                    document.body.appendChild(form);
                    form.submit();
                    document.body.removeChild(form);

                } else if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '操作失敗，且無法解析錯誤回應。' }));
                    alert(`錯誤: ${errorData.message}`);
                } else {
                    // For non-redirecting success, if any (e.g. if backend sent JSON for success)
                    // window.location.reload(); // Or handle specific JSON response
                }
            } catch (error) {
                console.error('批量操作錯誤:', error);
                alert('執行操作時發生網路或客戶端錯誤。');
            }
        }


        function handleGlobalDownload() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) return;
            // For download, we typically just need the paths
            const pathsToDownload = selectedItems.map(item => item.path);
            performBatchOperation('/batch-download', pathsToDownload);
        }

        function handleGlobalDelete() {
            const selectedItems = getSelectedItems();
            if (selectedItems.length === 0) return;
            if (!confirm(`確定要刪除選中的 ${selectedItems.length} 個項目嗎？此操作無法撤銷。`)) return;
            performBatchOperation('/batch-delete', selectedItems.map(item => ({ path: item.path, isDir: item.isDir })));
        }

        const movePopup = document.getElementById('move-destination-popup');
        const destinationPathInput = document.getElementById('destinationPath');
        let itemsToMoveGlobally = [];

        function showMovePopup() {
            itemsToMoveGlobally = getSelectedItems();
            if (itemsToMoveGlobally.length === 0) return;
            destinationPathInput.value = '/';
            movePopup.style.display = 'block';
        }
        function hideMovePopup() {
            movePopup.style.display = 'none';
        }
        function handleActualMove(event) {
            event.preventDefault();
            const destination = destinationPathInput.value.trim();
            if (!destination.startsWith('/')) {
                alert('目標路徑必須以 / 開頭 (相對於用戶根目錄)。');
                return;
            }
            if (itemsToMoveGlobally.length > 0) {
                performBatchOperation('/move-items',
                    itemsToMoveGlobally.map(item => ({ path: item.path, isDir: item.isDir, name: item.name })),
                    { destinationPath: destination }
                );
            }
            hideMovePopup();
        }

        // Initial setup
        updateGlobalActionButtons();
        itemCheckboxes.forEach(cb => cb.addEventListener('change', updateGlobalActionButtons));

    </script>
</body>
</html>
